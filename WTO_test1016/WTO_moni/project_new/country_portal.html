<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ä¼šå›½ä»£è¡¨é—¨æˆ· - WTOæ¨¡æ‹Ÿè°ˆåˆ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
            color: white;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 16px;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 20px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .country-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .selector-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            text-align: center;
        }

        .country-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }

        .country-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .country-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .country-card.selected {
            border-color: #10b981;
            background: #ecfdf5;
        }


        .country-flag-large {
            width: 48px;
            height: 36px;
            border-radius: 4px;
            margin: 0 auto 8px;
            object-fit: cover;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .country-name-large {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
            font-size: 14px;
            line-height: 1.2;
        }

        .country-status {
            font-size: 11px;
            color: #6b7280;
        }

        .session-input {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }

        .session-input input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            width: 200px;
        }

        .session-input input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .function-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .function-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .section-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
        }

        .section-desc {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .function-btn {
            display: block;
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .function-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .function-btn.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .function-btn.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .function-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .status-indicator.available {
            background: #10b981;
        }

        .status-indicator.unavailable {
            background: #ef4444;
        }

        .footer {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 40px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            font-weight: 500;
            text-align: center;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }

        /* å®æ—¶ä¿¡æ¯é¢æ¿åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .realtime-info-panel {
            animation: fadeIn 0.5s ease;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .function-grid {
                grid-template-columns: 1fr;
            }

            .country-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 32px;
            }

            .header p {
                font-size: 18px;
            }

            /* å®æ—¶ä¿¡æ¯é¢æ¿å“åº”å¼ */
            .realtime-info-panel > div:first-child {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .realtime-info-panel .info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .realtime-info-panel .meeting-timer {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ ä¸ä¼šå›½ä»£è¡¨é—¨æˆ·</h1>
            <p>WTOæ¨¡æ‹Ÿè°ˆåˆ¤ç³»ç»Ÿ - ä»£è¡¨å‚ä¸å¹³å°</p>
            <div style="font-size: 16px; opacity: 0.7;">é€‰æ‹©æ‚¨çš„å›½å®¶èº«ä»½ï¼Œå‚ä¸å®Œæ•´çš„ä¼šè®®æµç¨‹</div>
        </div>

        <!-- å›½å®¶é€‰æ‹© -->
        <div class="country-selector">
            <div class="selector-title">é€‰æ‹©æ‚¨çš„å›½å®¶èº«ä»½</div>
            <div style="text-align: center; margin-bottom: 16px; color: #6b7280; font-size: 14px;" id="country-count">
                æ­£åœ¨åŠ è½½å›½å®¶æ•°æ®...
            </div>
            
            <!-- æœç´¢æ¡† -->
            <div style="margin-bottom: 20px; text-align: center;">
                <input type="text" id="country-search" placeholder="æœç´¢å›½å®¶åç§°..." style="padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; width: 300px; max-width: 100%;">
            </div>
            
            <!-- å›½å®¶ç½‘æ ¼ -->
            <div class="country-grid" id="country-grid">
                <div style="text-align: center; padding: 40px; color: #6b7280; grid-column: 1 / -1;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸŒ</div>
                    <div>æ­£åœ¨åŠ è½½å›½å®¶åˆ—è¡¨...</div>
                </div>
            </div>
            
            <div class="session-input">
                <label for="session-id-input" style="font-weight: 600; color: #374151;">ä¼šè®®ç¼–å·:</label>
                <input type="text" id="session-id-input" placeholder="è¯·è¾“å…¥ä¼šè®®ç¼–å·" value="">
                <button onclick="updateSessionId()" style="padding: 12px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">æ›´æ–°</button>
            </div>
        </div>

        

        <!-- æç¤ºä¿¡æ¯ -->
        <div id="alert" class="alert"></div>

        <!-- åŠŸèƒ½æ¨¡å— -->
        <div class="function-grid" id="function-grid" style="display: none;">
            <!-- æ–‡ä»¶æäº¤ -->
            <div class="function-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ“„</div>
                    <div class="section-title">æ–‡ä»¶æäº¤</div>
                </div>
                <div class="section-desc">
                    æäº¤æ‚¨çš„ç«‹åœºæ–‡ä»¶ï¼Œé˜è¿°è§‚ç‚¹ï¼Œä¸ºåç»­è®¨è®ºå’ŒæŠ•ç¥¨å¥ å®šåŸºç¡€
                </div>
                <a href="#" class="function-btn primary" id="file-submit-btn" onclick="goToFileSubmit()">
                    ğŸ“ æäº¤ç«‹åœºæ–‡ä»¶
                    <span class="status-indicator available"></span>
                </a>
                <div style="font-size: 12px; color: #6b7280; text-align: center;">
                    ä¸Šä¼ æ–‡ä»¶ â€¢ å¡«å†™ä¿¡æ¯ â€¢ æäº¤ç«‹åœº
                </div>
            </div>

            <!-- åŠ¨è®®å‚ä¸ -->
            <div class="function-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ¤</div>
                    <div class="section-title">åŠ¨è®®è®¨è®º</div>
                </div>
                <div class="section-desc">
                    å‚ä¸åŠ¨è®®è®¨è®ºï¼ŒæŸ¥çœ‹å‘è¨€é¡ºåºï¼Œç”³è¯·å‘è¨€æœºä¼šï¼Œç­‰å¾…è½®æ¬¡å‘è¨€
                </div>
                <a href="#" class="function-btn" id="motion-btn" onclick="goToMotion()">
                    ğŸ™ï¸ å‚ä¸åŠ¨è®®è®¨è®º
                    <span class="status-indicator available"></span>
                </a>
                <div style="font-size: 12px; color: #6b7280; text-align: center;">
                    æŸ¥çœ‹å‘è¨€é¡ºåº â€¢ ç”³è¯·å‘è¨€ â€¢ ç­‰å¾…è½®æ¬¡
                </div>
            </div>

            <!-- æ–‡ä»¶æŠ•ç¥¨ -->
            <div class="function-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ—³ï¸</div>
                    <div class="section-title">æ–‡ä»¶æŠ•ç¥¨</div>
                </div>
                <div class="section-desc">
                    å¯¹å„å›½æäº¤çš„æ–‡ä»¶è¿›è¡ŒæŠ•ç¥¨è¡¨å†³ï¼Œè¡¨è¾¾æ‚¨çš„ç«‹åœºå’Œè§‚ç‚¹
                </div>
                <a href="#" class="function-btn success" id="vote-btn" onclick="goToVote()">
                    ğŸ“Š æ–‡ä»¶æŠ•ç¥¨è¡¨å†³
                    <span class="status-indicator available"></span>
                </a>
                <div style="font-size: 12px; color: #6b7280; text-align: center;">
                    æŸ¥çœ‹æ–‡ä»¶ â€¢ æŠ•ç¥¨è¡¨å†³ â€¢ æäº¤ç»“æœ
                </div>
            </div>

            <!-- å…±åŒå®£è¨€ -->
            <div class="function-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ“œ</div>
                    <div class="section-title">å…±åŒå®£è¨€</div>
                </div>
                <div class="section-desc">
                    æŸ¥çœ‹ä¼šè®®è¾¾æˆçš„å…±åŒå®£è¨€ï¼Œç¡®è®¤æœ€ç»ˆç«‹åœºï¼Œæä¾›åé¦ˆæ„è§
                </div>
                <a href="#" class="function-btn warning" id="declaration-btn" onclick="goToDeclaration()">
                    ğŸ“‹ æŸ¥çœ‹å…±åŒå®£è¨€
                    <span class="status-indicator available"></span>
                </a>
                <div style="font-size: 12px; color: #6b7280; text-align: center;">
                    æŸ¥çœ‹å®£è¨€ â€¢ ç¡®è®¤ç«‹åœº â€¢ æä¾›åé¦ˆ
                </div>
            </div>
        </div>

        <!-- å½“å‰é€‰æ‹©çš„å›½å®¶ä¿¡æ¯ -->
        <div id="selected-country-info" style="display: none;">
            <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 16px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px;">
                    <img id="selected-flag" src="" alt="" style="width: 48px; height: 36px; border-radius: 6px;">
                    <div>
                        <div style="font-size: 24px; font-weight: 600; color: #1e293b;" id="selected-name"></div>
                        <div style="font-size: 14px; color: #6b7280;">ä»£è¡¨å›¢å·²é€‰æ‹©</div>
                    </div>
                </div>
                <div style="font-size: 14px; color: #374151; margin-bottom: 20px;">
                    ä¼šè®®ç¼–å·ï¼š<strong id="selected-session">0000</strong> | 
                    è¯·ç‚¹å‡»ä¿å­˜æŒ‰é’®ç¡®è®¤æ‚¨çš„é€‰æ‹©
                </div>
                <button id="save-country-btn" onclick="saveCountrySelection()" style="
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 12px 24px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    margin-right: 12px;
                ">ä¿å­˜é€‰æ‹©</button>
                <button id="change-country-btn" onclick="changeCountrySelection()" style="
                    background: linear-gradient(135deg, #6b7280, #4b5563);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 12px 24px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">é‡æ–°é€‰æ‹©</button>
            </div>
        </div>

        <div class="footer">
            <p>ğŸ¯ å®Œæ•´çš„ä¸ä¼šå›½å‚ä¸ä½“éªŒ</p>
            <p>ğŸ’¡ æ‰€æœ‰åŠŸèƒ½éƒ½å·²é›†æˆçœŸå®APIå’Œæ•°æ®åº“</p>
            
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                <div style="background: rgba(255, 255, 255, 0.1); padding: 8px 16px; border-radius: 20px; font-size: 14px;">ğŸ¤ åŠ¨è®®å‚ä¸</div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 8px 16px; border-radius: 20px; font-size: 14px;">ğŸ—³ï¸ æ–‡ä»¶æŠ•ç¥¨</div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 8px 16px; border-radius: 20px; font-size: 14px;">ğŸ“œ å®£è¨€ç¡®è®¤</div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 8px 16px; border-radius: 20px; font-size: 14px;">ğŸ’¬ æ„è§åé¦ˆ</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let selectedCountryId = '';
        let selectedCountryName = '';
        let selectedCountryFlag = '';
        let sessionId = '0000';
        let allCountries = [];
        let filteredCountries = [];

        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¸ä¼šå›½ä»£è¡¨é—¨æˆ·å·²åŠ è½½');

            // ä»URLå‚æ•°è·å–session_idå’Œcountry_id
            const urlSessionId = getUrlParameter('session_id');
            const urlCountryId = getUrlParameter('country_id');

            if (urlSessionId) {
                sessionId = urlSessionId;
                document.getElementById('session-id-input').value = sessionId;
            }

            loadCountries().then(async () => {
                // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„å›½å®¶é€‰æ‹©
                if (urlCountryId) {
                    try {
                        // æ£€æŸ¥è¯¥å›½å®¶æ˜¯å¦å·²ä¿å­˜é€‰æ‹©
                        const checkResponse = await fetch(`/api/save_country_selection?session_id=${encodeURIComponent(sessionId)}&country_id=${encodeURIComponent(urlCountryId)}`, {
                            method: 'GET'
                        });

                        if (checkResponse.ok) {
                            // å›½å®¶å·²ä¿å­˜ï¼Œç›´æ¥æ˜¾ç¤ºåŠŸèƒ½åŒºåŸŸ
                            selectedCountryId = urlCountryId;
                            selectedCountryName = getUrlParameter('country_name') || '';

                            // æ˜¾ç¤ºåŠŸèƒ½åŒºåŸŸå’Œå®æ—¶ä¿¡æ¯é¢æ¿
                            document.getElementById('function-grid').style.display = 'grid';
                            document.getElementById('realtime-info-panel').style.display = 'block';
                            loadRealtimeInfo();
                            showAlert('æ¬¢è¿å›åˆ°ä¸ä¼šå›½é—¨æˆ·', 'success');
                        } else {
                            // å›½å®¶æœªä¿å­˜ï¼Œè‡ªåŠ¨é€‰æ‹©è¯¥å›½å®¶å¹¶æ˜¾ç¤ºä¿å­˜æŒ‰é’®
                            selectCountryById(urlCountryId);
                        }
                    } catch (error) {
                        // æ£€æŸ¥å¤±è´¥ï¼Œå›é€€åˆ°è‡ªåŠ¨é€‰æ‹©
                        selectCountryById(urlCountryId);
                    }
                }
                // å¦‚æœæ²¡æœ‰country_idå‚æ•°ï¼Œæ˜¾ç¤ºå›½å®¶é€‰æ‹©ç•Œé¢
            });

            setupSearchFilter();

            // å¼€å§‹å®æ—¶ä¿¡æ¯æ›´æ–°
            startRealtimeInfo();
        });

        // åŠ è½½å›½å®¶åˆ—è¡¨
        async function loadCountries() {
            try {
                const response = await fetch(`/api/countries?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    allCountries = data.data || [];
                    filteredCountries = [...allCountries];
                    renderCountries();
                    console.log('å›½å®¶åˆ—è¡¨å·²åŠ è½½:', allCountries.length, 'ä¸ªå›½å®¶');
                    return true;
                } else {
                    showAlert('åŠ è½½å›½å®¶åˆ—è¡¨å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('åŠ è½½å›½å®¶åˆ—è¡¨å¤±è´¥:', error);
                return false;
            }
        }

        // æ ¹æ®IDé€‰æ‹©å›½å®¶
        function selectCountryById(countryId) {
            const country = allCountries.find(c => c.id === countryId);
            if (country) {
                selectCountry(country.id, country.name, country.flag_url);
                showAlert(`å·²é€‰æ‹©ä»£è¡¨å›½å®¶ï¼š${country.name}`, 'success');
            } else {
                showAlert('æœªæ‰¾åˆ°æŒ‡å®šçš„å›½å®¶', 'error');
            }
        }

        // ä¿å­˜å›½å®¶é€‰æ‹©åˆ°æ•°æ®åº“
        async function saveCountrySelection() {
            if (!selectedCountryId || !selectedCountryName) {
                showAlert('è¯·å…ˆé€‰æ‹©å›½å®¶', 'error');
                return;
            }

            console.log('ä¿å­˜å›½å®¶é€‰æ‹©:', {
                session_id: sessionId,
                country_id: selectedCountryId,
                country_name: selectedCountryName,
                country_flag: selectedCountryFlag
            });

            try {
                const response = await fetch('/api/save_country_selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        country_id: selectedCountryId,
                        country_name: selectedCountryName,
                        country_flag: selectedCountryFlag
                    })
                });

                console.log('ä¿å­˜å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('ä¿å­˜å“åº”æ•°æ®:', data);
                
                if (data.code === 200) {
                    showAlert('å›½å®¶é€‰æ‹©å·²ä¿å­˜ï¼', 'success');
                    // éšè—ä¿å­˜æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠŸèƒ½åŒºåŸŸå’Œå®æ—¶ä¿¡æ¯é¢æ¿
                    document.getElementById('save-country-btn').style.display = 'none';
                    document.getElementById('change-country-btn').style.display = 'none';
                    document.getElementById('function-grid').style.display = 'grid';
                    document.getElementById('realtime-info-panel').style.display = 'block';

                    // å¼€å§‹åŠ è½½å®æ—¶ä¿¡æ¯
                    loadRealtimeInfo();
                } else {
                    showAlert('ä¿å­˜å¤±è´¥ï¼š' + data.message, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å›½å®¶é€‰æ‹©å¤±è´¥:', error);
            }
        }

        // é‡æ–°é€‰æ‹©å›½å®¶
        function changeCountrySelection() {
            // éšè—é€‰ä¸­å›½å®¶ä¿¡æ¯ï¼Œæ˜¾ç¤ºå›½å®¶é€‰æ‹©åŒºåŸŸ
            document.getElementById('selected-country-info').style.display = 'none';
            document.getElementById('country-selector').style.display = 'block';
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            selectedCountryId = '';
            selectedCountryName = '';
            selectedCountryFlag = '';

            showAlert('è¯·é‡æ–°é€‰æ‹©å›½å®¶', 'info');
        }

        // æ¸²æŸ“å›½å®¶åˆ—è¡¨
        function renderCountries() {
            const countryGrid = document.getElementById('country-grid');
            const countryCount = document.getElementById('country-count');
            
            // æ›´æ–°å›½å®¶æ•°é‡æ˜¾ç¤º
            if (filteredCountries.length === allCountries.length) {
                countryCount.textContent = `å…± ${allCountries.length} ä¸ªå›½å®¶å¯é€‰`;
            } else {
                countryCount.textContent = `æ‰¾åˆ° ${filteredCountries.length} ä¸ªå›½å®¶ï¼ˆå…± ${allCountries.length} ä¸ªï¼‰`;
            }
            
            if (filteredCountries.length === 0) {
                countryGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
                        <div>æœªæ‰¾åˆ°åŒ¹é…çš„å›½å®¶</div>
                        <div style="margin-top: 8px; font-size: 14px;">è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</div>
                    </div>
                `;
                return;
            }

            countryGrid.innerHTML = filteredCountries.map(country => `
                <div class="country-card" onclick="selectCountry('${country.id}', '${country.name}', '${country.flag_url}')">
                    <img class="country-flag-large" src="${country.flag_url}" alt="${country.name}" onerror="this.src='/static/flags/default.png'">
                    <div class="country-name-large">${country.name}</div>
                    
                </div>
            `).join('');
        }

        // è®¾ç½®æœç´¢è¿‡æ»¤
        function setupSearchFilter() {
            const searchInput = document.getElementById('country-search');
            
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (searchTerm === '') {
                    filteredCountries = [...allCountries];
                } else {
                    filteredCountries = allCountries.filter(country =>
                        country.name.toLowerCase().includes(searchTerm)
                    );
                }
                
                renderCountries();
            });

            // æ·»åŠ æœç´¢æ¡†ç„¦ç‚¹æ ·å¼
            searchInput.addEventListener('focus', function() {
                this.style.borderColor = '#3b82f6';
                this.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
            });

            searchInput.addEventListener('blur', function() {
                this.style.borderColor = '#e5e7eb';
                this.style.boxShadow = 'none';
            });
        }

        // é€‰æ‹©å›½å®¶
        function selectCountry(countryId, countryName, countryFlag) {
            selectedCountryId = countryId;
            selectedCountryName = countryName;
            selectedCountryFlag = countryFlag;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.country-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.country-card').classList.add('selected');

            // æ˜¾ç¤ºé€‰ä¸­çš„å›½å®¶ä¿¡æ¯
            document.getElementById('selected-flag').src = countryFlag;
            document.getElementById('selected-name').textContent = countryName;
            document.getElementById('selected-session').textContent = sessionId;
            document.getElementById('selected-country-info').style.display = 'block';

            // éšè—å›½å®¶é€‰æ‹©åŒºåŸŸ
            document.getElementById('country-selector').style.display = 'none';

            // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            document.getElementById('save-country-btn').style.display = 'inline-block';
            document.getElementById('change-country-btn').style.display = 'inline-block';

            showAlert(`å·²é€‰æ‹© ${countryName} ä»£è¡¨å›¢èº«ä»½ï¼Œè¯·ç‚¹å‡»ä¿å­˜æŒ‰é’®ç¡®è®¤`, 'success');
        }

        // æ›´æ–°ä¼šè®®ç¼–å·
        async function updateSessionId() {
            const newSessionId = document.getElementById('session-id-input').value.trim();
            if (newSessionId) {
                try {
                    // æ£€æŸ¥ä¼šè®®æ˜¯å¦å­˜åœ¨
                    const response = await fetch(`/api/get_session_info?session_id=${encodeURIComponent(newSessionId)}`);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        // ä¼šè®®å­˜åœ¨
                        sessionId = newSessionId;
                        if (selectedCountryId) {
                            document.getElementById('selected-session').textContent = sessionId;
                        }
                        showAlert(`ä¼šè®®ç¼–å·å·²æ›´æ–°ä¸ºï¼š${sessionId}ï¼Œæ­£åœ¨é‡æ–°åŠ è½½å›½å®¶åˆ—è¡¨...`, 'success');
                        loadCountries();
                    } else if (data.code === 404) {
                        // ä¼šè®®ä¸å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦åˆ›å»º
                        const createNew = confirm(`ä¼šè®®ç¼–å· ${newSessionId} ä¸å­˜åœ¨ã€‚\n\næ˜¯å¦è¦åˆ›å»ºæ–°çš„ä¼šè®®ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"åˆ›å»ºæ–°ä¼šè®®\nç‚¹å‡»"å–æ¶ˆ"é‡æ–°è¾“å…¥ä¼šè®®ç¼–å·`);
                        
                        if (createNew) {
                            await createNewSessionForCountry(newSessionId);
                        } else {
                            document.getElementById('session-id-input').focus();
                            document.getElementById('session-id-input').select();
                        }
                    } else {
                        showAlert('æ£€æŸ¥ä¼šè®®ä¿¡æ¯å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ä¼šè®®ä¿¡æ¯å¤±è´¥:', error);
                    showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'error');
                }
            }
        }

        // ä¸ºä¸ä¼šå›½åˆ›å»ºæ–°ä¼šè®®
        async function createNewSessionForCountry(sessionId) {
            try {
                showAlert('æ­£åœ¨åˆ›å»ºæ–°ä¼šè®®...', 'success');
                
                const response = await fetch('/api/create_new_session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        committee_name: 'WTOå§”å‘˜ä¼š',
                        agenda: 'ä¼šè®®è®®é¢˜',
                        created_by: 'country'
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    window.sessionId = sessionId;
                    if (selectedCountryId) {
                        document.getElementById('selected-session').textContent = sessionId;
                    }
                    
                    showAlert(`æ–°ä¼šè®® ${sessionId} åˆ›å»ºæˆåŠŸï¼æ­£åœ¨åŠ è½½å›½å®¶åˆ—è¡¨...`, 'success');
                    loadCountries();
                } else {
                    showAlert('åˆ›å»ºæ–°ä¼šè®®å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
                
            } catch (error) {
                console.error('åˆ›å»ºæ–°ä¼šè®®å¤±è´¥:', error);
                showAlert('åˆ›å»ºæ–°ä¼šè®®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }

        // è·³è½¬åˆ°æ–‡ä»¶æäº¤
        function goToFileSubmit() {
            if (!selectedCountryId) {
                showAlert('è¯·å…ˆé€‰æ‹©æ‚¨çš„å›½å®¶èº«ä»½', 'error');
                return;
            }
            
            const url = `/file-upload-submit?session_id=${encodeURIComponent(sessionId)}&committee_name=WTOäº‰ç«¯è§£å†³å§”å‘˜ä¼š&agenda=å›½é™…è´¸æ˜“äº‰ç«¯è§£å†³æœºåˆ¶æ”¹é©&country_id=${encodeURIComponent(selectedCountryId)}&country_name=${encodeURIComponent(selectedCountryName)}`;
            window.location.href = url;
        }

        // è·³è½¬åˆ°åŠ¨è®®å‚ä¸
        function goToMotion() {
            if (!selectedCountryId) {
                showAlert('è¯·å…ˆé€‰æ‹©æ‚¨çš„å›½å®¶èº«ä»½', 'error');
                return;
            }
            
            const url = `/country-motion?session_id=${encodeURIComponent(sessionId)}&committee_name=WTOäº‰ç«¯è§£å†³å§”å‘˜ä¼š&agenda=å›½é™…è´¸æ˜“äº‰ç«¯è§£å†³æœºåˆ¶æ”¹é©&country_id=${encodeURIComponent(selectedCountryId)}&country_name=${encodeURIComponent(selectedCountryName)}`;
            window.location.href = url;
        }

        // è·³è½¬åˆ°æ–‡ä»¶æŠ•ç¥¨
        function goToVote() {
            if (!selectedCountryId) {
                showAlert('è¯·å…ˆé€‰æ‹©æ‚¨çš„å›½å®¶èº«ä»½', 'error');
                return;
            }
            
            const url = `/country-file-vote?session_id=${encodeURIComponent(sessionId)}&committee_name=WTOäº‰ç«¯è§£å†³å§”å‘˜ä¼š&agenda=å›½é™…è´¸æ˜“äº‰ç«¯è§£å†³æœºåˆ¶æ”¹é©&country_id=${encodeURIComponent(selectedCountryId)}&country_name=${encodeURIComponent(selectedCountryName)}`;
            window.location.href = url;
        }

        // è·³è½¬åˆ°å…±åŒå®£è¨€
        function goToDeclaration() {
            if (!selectedCountryId) {
                showAlert('è¯·å…ˆé€‰æ‹©æ‚¨çš„å›½å®¶èº«ä»½', 'error');
                return;
            }
            
            const url = `/country-declaration?session_id=${encodeURIComponent(sessionId)}&committee_name=WTOäº‰ç«¯è§£å†³å§”å‘˜ä¼š&agenda=å›½é™…è´¸æ˜“äº‰ç«¯è§£å†³æœºåˆ¶æ”¹é©&country_id=${encodeURIComponent(selectedCountryId)}&country_name=${encodeURIComponent(selectedCountryName)}`;
            window.location.href = url;
        }



        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
