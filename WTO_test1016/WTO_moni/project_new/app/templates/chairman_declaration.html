<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主席共同宣言管理｜WTO 模拟谈判</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left h1 {
            text-align: center;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 8px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .session-info {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .session-info h3 {
            margin: 0 0 16px;
            color: #1e293b;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .info-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        .declaration-status {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .declaration-status strong {
            color: #065f46;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .panel-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .panel-title-text {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .source-files {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .country-flag {
            width: 32px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .file-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .file-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: #10b981;
            color: white;
        }

        .declaration-editor {
            height: 100%;
        }

        .editor-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .declaration-textarea {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.8;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .declaration-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .generation-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .generation-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .option-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .option-card.selected {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .option-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .option-desc {
            font-size: 14px;
            color: #6b7280;
        }

        .stats-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .controls {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buttons,
            .editor-toolbar {
                flex-direction: column;
            }
            
            .generation-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-left">
            <h1>WTO 模拟谈判 - 共同宣言管理</h1>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <h1>📜 共同宣言管理</h1>
            <p>基于投票通过的文件生成和管理共同宣言</p>
        </div>

        <!-- 会议信息 -->
        <div class="session-info">
            <h3>📋 会议信息</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">会议编号：</span>
                    <span class="info-value">{{ session_id or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">委员会：</span>
                    <span class="info-value">{{ committee_name or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">议题：</span>
                    <span class="info-value">{{ agenda or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">宣言生成时间：</span>
                    <span class="info-value" id="generation-time">-</span>
                </div>
            </div>
            <div class="declaration-status">
                <strong>宣言状态：</strong>
                <span id="declaration-status-text">准备生成</span>
                <span style="color: #6b7280; margin-left: 10px;" id="source-files-count">基于0个通过投票的文件</span>
            </div>
        </div>

        <!-- 宣言生成选项 -->
        <div class="generation-section">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="panel-icon">🤖</div>
                    <div class="panel-title-text">宣言生成选项</div>
                </div>
            </div>
            
            <div class="generation-options">
                <div class="option-card selected" onclick="selectOption('ai')" id="option-ai">
                    <div class="option-title">🤖 AI智能生成</div>
                    <div class="option-desc">基于通过投票的文件，使用AI生成共同宣言</div>
                </div>
                
                <div class="option-card" onclick="selectOption('template')" id="option-template">
                    <div class="option-title">📋 模板生成</div>
                    <div class="option-desc">使用标准模板，手动填入关键信息</div>
                </div>
                
                <div class="option-card" onclick="selectOption('manual')" id="option-manual">
                    <div class="option-title">✏️ 手动编写</div>
                    <div class="option-desc">主席完全手动编写共同宣言内容</div>
                </div>
            </div>
        </div>

        <!-- 提示信息 -->
        <div id="alert" class="alert"></div>

        <!-- 主要内容 -->
        <div class="main-content">
            <!-- 源文件列表 -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">📄</div>
                        <div class="panel-title-text">通过投票文件</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshFiles()">🔄 刷新</button>
                    </div>
                </div>
                
                <div class="source-files" id="source-files">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📄</div>
                        <div>正在加载通过投票的文件...</div>
                    </div>
                </div>
            </div>
            
            <!-- 宣言编辑器 -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">📝</div>
                        <div class="panel-title-text">宣言编辑器</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-primary btn-small" onclick="generateDeclaration()" id="generate-btn">🤖 生成宣言</button>
                        <button class="btn btn-secondary btn-small" onclick="loadTemplate()">📋 加载模板</button>
                    </div>
                </div>
                
                <div class="declaration-editor">
                    <div class="editor-toolbar">
                        <button class="btn btn-secondary btn-small" onclick="insertTemplate('opening')">🎯 插入开头</button>
                        <button class="btn btn-secondary btn-small" onclick="insertTemplate('closing')">🎯 插入结尾</button>
                        <button class="btn btn-warning btn-small" onclick="saveDraft()">💾 保存草稿</button>
                        <button class="btn btn-secondary btn-small" onclick="clearContent()">🗑️ 清空内容</button>
                    </div>
                    
                    <textarea class="declaration-textarea" id="declaration-content" placeholder="共同宣言将在这里生成或编辑...

点击"🤖 生成宣言"按钮基于通过投票的文件自动生成宣言，
或者点击"📋 加载模板"使用标准模板，
也可以直接在此处手动编写宣言内容。"></textarea>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="passed-files-count">0</div>
                    <div class="stat-label">通过文件数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="participating-countries">0</div>
                    <div class="stat-label">参与国家</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="declaration-words">0</div>
                    <div class="stat-label">宣言字数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="current-status">草稿</div>
                    <div class="stat-label">当前状态</div>
                </div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="controls">
            <div class="buttons">
                <button class="btn btn-primary" onclick="generateDeclaration()" id="generate-btn-main">
                    🤖 生成宣言
                </button>
                <button class="btn btn-warning" onclick="previewDeclaration()">
                    👁️ 预览宣言
                </button>
                <button class="btn btn-success" onclick="finalizeDeclaration()" id="finalize-btn" disabled>
                    ✅ 确认定稿
                </button>
                <button class="btn btn-primary" onclick="exportPDF()" id="export-btn" disabled>
                    📄 导出PDF
                </button>
                <button class="btn btn-secondary" onclick="shareDeclaration()" id="share-btn" disabled>
                    📤 分享宣言
                </button>
                <button class="btn btn-secondary" onclick="goBack()">
                    ← 返回投票监控
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let sessionId = "{{ session_id or '' }}";
        let committeeName = "{{ committee_name or '' }}";
        let agenda = "{{ agenda or '' }}";
        
        let selectedOption = 'ai';
        let declarationStatus = 'draft';
        let passedFiles = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('主席共同宣言管理页面已加载');
            console.log('会议信息:', { sessionId, committeeName, agenda });
            
            loadPassedFiles();
            setupEventListeners();
        });

        // 设置事件监听器
        function setupEventListeners() {
            const textarea = document.getElementById('declaration-content');
            textarea.addEventListener('input', updateWordCount);
            
            // 自动保存功能
            let autoSaveTimer;
            textarea.addEventListener('input', () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveDraft();
                }, 10000); // 10秒后自动保存
            });
        }

        // 加载通过投票的文件
        async function loadPassedFiles() {
            try {
                const response = await fetch(`/api/get_passed_submissions?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    passedFiles = data.data || [];
                    renderPassedFiles();
                    updateStats();
                    
                    console.log('通过投票的文件已加载:', passedFiles.length, '个文件');
                    
                    if (passedFiles.length === 0) {
                        showAlert('暂无通过投票的文件，请先完成投票流程', 'error');
                    }
                } else {
                    showAlert('加载通过投票的文件失败：' + (data.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('加载通过投票的文件失败:', error);
                showAlert('网络错误，请检查连接后重试', 'error');
            }
        }

        // 渲染通过投票的文件
        function renderPassedFiles() {
            const sourceFilesEl = document.getElementById('source-files');
            
            if (passedFiles.length === 0) {
                sourceFilesEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📄</div>
                        <div>暂无通过投票的文件</div>
                        <div style="margin-top: 8px; font-size: 14px;">请先完成投票流程</div>
                    </div>
                `;
                return;
            }
            
            sourceFilesEl.innerHTML = passedFiles.map(file => `
                <div class="file-item">
                    <img class="country-flag" src="${file.flag_url || '/static/flags/default.png'}" alt="${file.country_name}" onerror="this.src='/static/flags/default.png'">
                    <div class="file-info">
                        <div class="file-title">${file.file_name || '文本提交'}</div>
                        <div class="file-meta">${file.country_name} • 已通过投票</div>
                    </div>
                    <span class="file-status">✅ 通过</span>
                </div>
            `).join('');
        }

        // 选择生成选项
        function selectOption(option) {
            selectedOption = option;
            
            // 更新选中状态
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`option-${option}`).classList.add('selected');
            
            const optionNames = {
                'ai': 'AI智能生成',
                'template': '模板生成',
                'manual': '手动编写'
            };
            
            showAlert(`已选择：${optionNames[option]}`, 'success');
        }

        // 生成宣言
        async function generateDeclaration() {
            if (passedFiles.length === 0) {
                showAlert('没有通过投票的文件，无法生成宣言', 'error');
                return;
            }
            
            const btn = document.getElementById('generate-btn');
            const btnMain = document.getElementById('generate-btn-main');
            
            btn.disabled = true;
            btnMain.disabled = true;
            btn.textContent = '🤖 生成中...';
            btnMain.textContent = '🤖 生成中...';
            
            try {
                // 🔥 修改：调用新的优化API，支持PDF文本提取和AI生成
                const response = await fetch(`/api/generate_declaration?session_id=${encodeURIComponent(sessionId)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        generation_type: selectedOption
                    })
                });
                
                const data = await response.json();
                
                // 🔥 修改：兼容新API的返回格式
                if (data.success || data.code === 200) {
                    const declarationText = data.declaration || (data.data && data.data.declaration) || '';
                    
                    document.getElementById('declaration-content').value = declarationText;
                    document.getElementById('generation-time').textContent = new Date().toLocaleString();
                    
                    declarationStatus = 'generated';
                    document.getElementById('declaration-status-text').textContent = '已生成草稿';
                    document.getElementById('current-status').textContent = '草稿';
                    
                    // 启用相关按钮
                    document.getElementById('finalize-btn').disabled = false;
                    document.getElementById('export-btn').disabled = false;
                    document.getElementById('share-btn').disabled = false;
                    
                    updateWordCount();
                    
                    // 显示详细信息
                    const participatingCountries = data.participating_countries || [];
                    const countryList = participatingCountries.length > 0 
                        ? `，参与国家：${participatingCountries.join('、')}` 
                        : '';
                    
                    showAlert(`✅ 共同宣言生成成功！基于${passedFiles.length}个通过投票的PDF文件${countryList}`, 'success');
                    
                    console.log('生成详情:', data);
                } else {
                    showAlert(data.error || data.message || '生成宣言失败', 'error');
                }
                
            } catch (error) {
                console.error('生成宣言失败:', error);
                showAlert('生成宣言时发生错误：' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btnMain.disabled = false;
                btn.textContent = '🤖 生成宣言';
                btnMain.textContent = '🤖 生成宣言';
            }
        }

        // 加载模板
        function loadTemplate() {
            const template = `我们，[参与国家列表]的代表，在WTO框架下就[议题]进行了深入讨论和磋商，达成以下共识：

一、[主要议题一]

[具体内容和措施]

二、[主要议题二]

[具体内容和措施]

三、[主要议题三]

[具体内容和措施]

四、实施路径

[实施计划和时间安排]

我们呼吁所有WTO成员积极参与这一重要进程，共同维护多边贸易体系。

[签署国家]
[日期]`;
            
            if (confirm('加载模板将覆盖当前内容，确定继续吗？')) {
                document.getElementById('declaration-content').value = template;
                updateWordCount();
                showAlert('标准模板已加载', 'success');
            }
        }

        // 插入模板片段
        function insertTemplate(type) {
            const textarea = document.getElementById('declaration-content');
            const templates = {
                'opening': '我们，[国家名称]的代表，在WTO框架下就[议题]进行了深入讨论和磋商，达成以下共识：\n\n',
                'closing': '\n\n我们呼吁所有WTO成员积极参与这一重要进程，共同维护和完善多边贸易体系。\n\n[签署国家]\n[日期]'
            };
            
            const template = templates[type];
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(textarea.selectionEnd);
            
            textarea.value = textBefore + template + textAfter;
            textarea.focus();
            textarea.setSelectionRange(cursorPos + template.length, cursorPos + template.length);
            
            updateWordCount();
        }

        // 清空内容
        function clearContent() {
            if (confirm('确定要清空所有内容吗？')) {
                document.getElementById('declaration-content').value = '';
                updateWordCount();
                showAlert('内容已清空', 'success');
            }
        }

        // 保存草稿
        function saveDraft() {
            const content = document.getElementById('declaration-content').value;
            localStorage.setItem(`declaration-draft-${sessionId}`, content);
            showAlert('宣言草稿已保存', 'success');
        }

        // 预览宣言
        function previewDeclaration() {
            const content = document.getElementById('declaration-content').value;
            if (!content.trim()) {
                showAlert('请先生成或编写宣言内容', 'error');
                return;
            }
            
            // 打开新窗口预览
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>共同宣言预览</title>
                    <style>
                        body { font-family: 'Microsoft YaHei', Arial, sans-serif; padding: 40px; line-height: 1.8; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #ccc; padding-bottom: 20px; }
                        .content { white-space: pre-wrap; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>WTO模拟谈判共同宣言</h1>
                        <p>会议编号：${sessionId} | 委员会：${committeeName}</p>
                    </div>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
        }

        // 确认定稿
        async function finalizeDeclaration() {
            const content = document.getElementById('declaration-content').value;
            if (!content.trim()) {
                showAlert('请先生成或编写宣言内容', 'error');
                return;
            }
            
            if (confirm('确认定稿后将无法修改，确定要定稿吗？')) {
                try {
                    const response = await fetch('/api/finalize_declaration', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            declaration: content
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        declarationStatus = 'finalized';
                        document.getElementById('declaration-status-text').textContent = '已确认定稿';
                        document.getElementById('current-status').textContent = '定稿';
                        
                        // 禁用编辑功能
                        document.getElementById('declaration-content').readOnly = true;
                        document.querySelectorAll('.editor-toolbar .btn').forEach(btn => {
                            btn.disabled = true;
                        });
                        document.getElementById('generate-btn').disabled = true;
                        document.getElementById('generate-btn-main').disabled = true;
                        
                        showAlert('共同宣言已确认定稿！', 'success');
                    } else {
                        showAlert(data.message || '定稿失败', 'error');
                    }
                    
                } catch (error) {
                    console.error('定稿失败:', error);
                    showAlert('定稿时发生错误', 'error');
                }
            }
        }

        // 导出PDF
        async function exportPDF() {
            const content = document.getElementById('declaration-content').value;
            if (!content.trim()) {
                showAlert('请先生成或编写宣言内容', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/export_declaration_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        declaration: content,
                        committee_name: committeeName,
                        agenda: agenda
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `共同宣言_${sessionId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showAlert('PDF已导出', 'success');
                } else {
                    showAlert('PDF导出失败', 'error');
                }
                
            } catch (error) {
                console.error('导出PDF失败:', error);
                showAlert('导出时发生错误', 'error');
            }
        }

        // 分享宣言
        function shareDeclaration() {
            const content = document.getElementById('declaration-content').value;
            if (!content.trim()) {
                showAlert('请先生成或编写宣言内容', 'error');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: 'WTO共同宣言',
                    text: content.substring(0, 200) + '...',
                    url: window.location.href
                });
            } else {
                // 复制到剪贴板
                navigator.clipboard.writeText(content).then(() => {
                    showAlert('宣言内容已复制到剪贴板', 'success');
                });
            }
        }

        // 刷新文件
        async function refreshFiles() {
            showAlert('正在刷新文件列表...', 'success');
            await loadPassedFiles();
            showAlert('文件列表已刷新', 'success');
        }

        // 更新统计信息
        function updateStats() {
            document.getElementById('passed-files-count').textContent = passedFiles.length;
            document.getElementById('participating-countries').textContent = passedFiles.length; // 假设每个文件对应一个国家
            document.getElementById('source-files-count').textContent = `基于${passedFiles.length}个通过投票的文件`;
        }

        // 更新字数统计
        function updateWordCount() {
            const content = document.getElementById('declaration-content').value;
            const wordCount = content.length;
            document.getElementById('declaration-words').textContent = wordCount.toLocaleString();
        }

        // 返回投票监控
        function goBack() {
            const url = `/chairman-vote-monitoring?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
            window.location.href = url;
        }

        // 显示提示信息
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>

