<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»å¸­å…±åŒå®£è¨€ç®¡ç†ï½œWTO æ¨¡æ‹Ÿè°ˆåˆ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left h1 {
            text-align: center;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 8px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .session-info {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .session-info h3 {
            margin: 0 0 16px;
            color: #1e293b;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .info-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        .declaration-status {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .declaration-status strong {
            color: #065f46;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .panel-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .panel-title-text {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .source-files {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .country-flag {
            width: 32px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .file-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .file-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: #10b981;
            color: white;
        }

        .declaration-editor {
            height: 100%;
        }

        .editor-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .declaration-textarea {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.8;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .declaration-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .generation-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .generation-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .option-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .option-card.selected {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .option-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .option-desc {
            font-size: 14px;
            color: #6b7280;
        }

        .stats-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .controls {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buttons,
            .editor-toolbar {
                flex-direction: column;
            }
            
            .generation-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-left">
            <h1>WTO æ¨¡æ‹Ÿè°ˆåˆ¤ - å…±åŒå®£è¨€ç®¡ç†</h1>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <h1>ğŸ“œ å…±åŒå®£è¨€ç®¡ç†</h1>
            <p>åŸºäºæŠ•ç¥¨é€šè¿‡çš„æ–‡ä»¶ç”Ÿæˆå’Œç®¡ç†å…±åŒå®£è¨€</p>
        </div>

        <!-- ä¼šè®®ä¿¡æ¯ -->
        <div class="session-info">
            <h3>ğŸ“‹ ä¼šè®®ä¿¡æ¯</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">ä¼šè®®ç¼–å·ï¼š</span>
                    <span class="info-value">{{ session_id or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å§”å‘˜ä¼šï¼š</span>
                    <span class="info-value">{{ committee_name or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">è®®é¢˜ï¼š</span>
                    <span class="info-value">{{ agenda or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å®£è¨€ç”Ÿæˆæ—¶é—´ï¼š</span>
                    <span class="info-value" id="generation-time">-</span>
                </div>
            </div>
            <div class="declaration-status">
                <strong>å®£è¨€çŠ¶æ€ï¼š</strong>
                <span id="declaration-status-text">å‡†å¤‡ç”Ÿæˆ</span>
                <span style="color: #6b7280; margin-left: 10px;" id="source-files-count">åŸºäº0ä¸ªé€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶</span>
            </div>
        </div>

        <!-- å®£è¨€ç”Ÿæˆé€‰é¡¹ -->
        <div class="generation-section">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="panel-icon">ğŸ¤–</div>
                    <div class="panel-title-text">å®£è¨€ç”Ÿæˆé€‰é¡¹</div>
                </div>
            </div>
            
            <div class="generation-options">
                <div class="option-card selected" onclick="selectOption('ai')" id="option-ai">
                    <div class="option-title">ğŸ¤– AIæ™ºèƒ½ç”Ÿæˆ</div>
                    <div class="option-desc">åŸºäºé€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶ï¼Œä½¿ç”¨AIç”Ÿæˆå…±åŒå®£è¨€</div>
                </div>
                
                <div class="option-card" onclick="selectOption('template')" id="option-template">
                    <div class="option-title">ğŸ“‹ æ¨¡æ¿ç”Ÿæˆ</div>
                    <div class="option-desc">ä½¿ç”¨æ ‡å‡†æ¨¡æ¿ï¼Œæ‰‹åŠ¨å¡«å…¥å…³é”®ä¿¡æ¯</div>
                </div>
                
                <div class="option-card" onclick="selectOption('manual')" id="option-manual">
                    <div class="option-title">âœï¸ æ‰‹åŠ¨ç¼–å†™</div>
                    <div class="option-desc">ä¸»å¸­å®Œå…¨æ‰‹åŠ¨ç¼–å†™å…±åŒå®£è¨€å†…å®¹</div>
                </div>
            </div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div id="alert" class="alert"></div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- æºæ–‡ä»¶åˆ—è¡¨ -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">ğŸ“„</div>
                        <div class="panel-title-text">é€šè¿‡æŠ•ç¥¨æ–‡ä»¶</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshFiles()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                
                <div class="source-files" id="source-files">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
                        <div>æ­£åœ¨åŠ è½½é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶...</div>
                    </div>
                </div>
            </div>
            
            <!-- å®£è¨€ç¼–è¾‘å™¨ -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">ğŸ“</div>
                        <div class="panel-title-text">å®£è¨€ç¼–è¾‘å™¨</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-primary btn-small" onclick="generateDeclaration()" id="generate-btn">ğŸ¤– ç”Ÿæˆå®£è¨€</button>
                        <button class="btn btn-secondary btn-small" onclick="loadTemplate()">ğŸ“‹ åŠ è½½æ¨¡æ¿</button>
                    </div>
                </div>
                
                <div class="declaration-editor">
                    <div class="editor-toolbar">
                        <button class="btn btn-secondary btn-small" onclick="insertTemplate('opening')">ğŸ¯ æ’å…¥å¼€å¤´</button>
                        <button class="btn btn-secondary btn-small" onclick="insertTemplate('closing')">ğŸ¯ æ’å…¥ç»“å°¾</button>
                        <button class="btn btn-warning btn-small" onclick="saveDraft()">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
                        <button class="btn btn-secondary btn-small" onclick="clearContent()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                    </div>
                    
                    <textarea class="declaration-textarea" id="declaration-content" placeholder="å…±åŒå®£è¨€å°†åœ¨è¿™é‡Œç”Ÿæˆæˆ–ç¼–è¾‘...

ç‚¹å‡»"ğŸ¤– ç”Ÿæˆå®£è¨€"æŒ‰é’®åŸºäºé€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆå®£è¨€ï¼Œ
æˆ–è€…ç‚¹å‡»"ğŸ“‹ åŠ è½½æ¨¡æ¿"ä½¿ç”¨æ ‡å‡†æ¨¡æ¿ï¼Œ
ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æ­¤å¤„æ‰‹åŠ¨ç¼–å†™å®£è¨€å†…å®¹ã€‚"></textarea>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="passed-files-count">0</div>
                    <div class="stat-label">é€šè¿‡æ–‡ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="participating-countries">0</div>
                    <div class="stat-label">å‚ä¸å›½å®¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="declaration-words">0</div>
                    <div class="stat-label">å®£è¨€å­—æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="current-status">è‰ç¨¿</div>
                    <div class="stat-label">å½“å‰çŠ¶æ€</div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="buttons">
                <button class="btn btn-primary" onclick="generateDeclaration()" id="generate-btn-main">
                    ğŸ¤– ç”Ÿæˆå®£è¨€
                </button>
                <button class="btn btn-warning" onclick="previewDeclaration()">
                    ğŸ‘ï¸ é¢„è§ˆå®£è¨€
                </button>
                <button class="btn btn-success" onclick="finalizeDeclaration()" id="finalize-btn" disabled>
                    âœ… ç¡®è®¤å®šç¨¿
                </button>
                <button class="btn btn-primary" onclick="exportPDF()" id="export-btn" disabled>
                    ğŸ“„ å¯¼å‡ºPDF
                </button>
                <button class="btn btn-secondary" onclick="shareDeclaration()" id="share-btn" disabled>
                    ğŸ“¤ åˆ†äº«å®£è¨€
                </button>
                <button class="btn btn-secondary" onclick="goBack()">
                    â† è¿”å›æŠ•ç¥¨ç›‘æ§
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let sessionId = "{{ session_id or '' }}";
        let committeeName = "{{ committee_name or '' }}";
        let agenda = "{{ agenda or '' }}";
        
        let selectedOption = 'ai';
        let declarationStatus = 'draft';
        let passedFiles = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¸»å¸­å…±åŒå®£è¨€ç®¡ç†é¡µé¢å·²åŠ è½½');
            console.log('ä¼šè®®ä¿¡æ¯:', { sessionId, committeeName, agenda });
            
            loadPassedFiles();
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            const textarea = document.getElementById('declaration-content');
            textarea.addEventListener('input', updateWordCount);
            
            // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
            let autoSaveTimer;
            textarea.addEventListener('input', () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveDraft();
                }, 10000); // 10ç§’åè‡ªåŠ¨ä¿å­˜
            });
        }

        // åŠ è½½é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶
        async function loadPassedFiles() {
            try {
                const response = await fetch(`/api/get_passed_submissions?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    passedFiles = data.data || [];
                    renderPassedFiles();
                    updateStats();
                    
                    console.log('é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶å·²åŠ è½½:', passedFiles.length, 'ä¸ªæ–‡ä»¶');
                    
                    if (passedFiles.length === 0) {
                        showAlert('æš‚æ— é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶ï¼Œè¯·å…ˆå®ŒæˆæŠ•ç¥¨æµç¨‹', 'error');
                    }
                } else {
                    showAlert('åŠ è½½é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åŠ è½½é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶å¤±è´¥:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'error');
            }
        }

        // æ¸²æŸ“é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶
        function renderPassedFiles() {
            const sourceFilesEl = document.getElementById('source-files');
            
            if (passedFiles.length === 0) {
                sourceFilesEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
                        <div>æš‚æ— é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶</div>
                        <div style="margin-top: 8px; font-size: 14px;">è¯·å…ˆå®ŒæˆæŠ•ç¥¨æµç¨‹</div>
                    </div>
                `;
                return;
            }
            
            sourceFilesEl.innerHTML = passedFiles.map(file => `
                <div class="file-item">
                    <img class="country-flag" src="${file.flag_url || '/static/flags/default.png'}" alt="${file.country_name}" onerror="this.src='/static/flags/default.png'">
                    <div class="file-info">
                        <div class="file-title">${file.file_name || 'æ–‡æœ¬æäº¤'}</div>
                        <div class="file-meta">${file.country_name} â€¢ å·²é€šè¿‡æŠ•ç¥¨</div>
                    </div>
                    <span class="file-status">âœ… é€šè¿‡</span>
                </div>
            `).join('');
        }

        // é€‰æ‹©ç”Ÿæˆé€‰é¡¹
        function selectOption(option) {
            selectedOption = option;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`option-${option}`).classList.add('selected');
            
            const optionNames = {
                'ai': 'AIæ™ºèƒ½ç”Ÿæˆ',
                'template': 'æ¨¡æ¿ç”Ÿæˆ',
                'manual': 'æ‰‹åŠ¨ç¼–å†™'
            };
            
            showAlert(`å·²é€‰æ‹©ï¼š${optionNames[option]}`, 'success');
        }

        // ç”Ÿæˆå®£è¨€
        async function generateDeclaration() {
            if (passedFiles.length === 0) {
                showAlert('æ²¡æœ‰é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶ï¼Œæ— æ³•ç”Ÿæˆå®£è¨€', 'error');
                return;
            }
            
            const btn = document.getElementById('generate-btn');
            const btnMain = document.getElementById('generate-btn-main');
            
            btn.disabled = true;
            btnMain.disabled = true;
            btn.textContent = 'ğŸ¤– ç”Ÿæˆä¸­...';
            btnMain.textContent = 'ğŸ¤– ç”Ÿæˆä¸­...';
            
            try {
                // ğŸ”¥ ä¿®æ”¹ï¼šè°ƒç”¨æ–°çš„ä¼˜åŒ–APIï¼Œæ”¯æŒPDFæ–‡æœ¬æå–å’ŒAIç”Ÿæˆ
                const response = await fetch(`/api/generate_declaration?session_id=${encodeURIComponent(sessionId)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        generation_type: selectedOption
                    })
                });
                
                const data = await response.json();
                
                // ğŸ”¥ ä¿®æ”¹ï¼šå…¼å®¹æ–°APIçš„è¿”å›æ ¼å¼
                if (data.success || data.code === 200) {
                    const declarationText = data.declaration || (data.data && data.data.declaration) || '';
                    
                    document.getElementById('declaration-content').value = declarationText;
                    document.getElementById('generation-time').textContent = new Date().toLocaleString();
                    
                    declarationStatus = 'generated';
                    document.getElementById('declaration-status-text').textContent = 'å·²ç”Ÿæˆè‰ç¨¿';
                    document.getElementById('current-status').textContent = 'è‰ç¨¿';
                    
                    // å¯ç”¨ç›¸å…³æŒ‰é’®
                    document.getElementById('finalize-btn').disabled = false;
                    document.getElementById('export-btn').disabled = false;
                    document.getElementById('share-btn').disabled = false;
                    
                    updateWordCount();
                    
                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    const participatingCountries = data.participating_countries || [];
                    const countryList = participatingCountries.length > 0 
                        ? `ï¼Œå‚ä¸å›½å®¶ï¼š${participatingCountries.join('ã€')}` 
                        : '';
                    
                    showAlert(`âœ… å…±åŒå®£è¨€ç”ŸæˆæˆåŠŸï¼åŸºäº${passedFiles.length}ä¸ªé€šè¿‡æŠ•ç¥¨çš„PDFæ–‡ä»¶${countryList}`, 'success');
                    
                    console.log('ç”Ÿæˆè¯¦æƒ…:', data);
                } else {
                    showAlert(data.error || data.message || 'ç”Ÿæˆå®£è¨€å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆå®£è¨€å¤±è´¥:', error);
                showAlert('ç”Ÿæˆå®£è¨€æ—¶å‘ç”Ÿé”™è¯¯ï¼š' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btnMain.disabled = false;
                btn.textContent = 'ğŸ¤– ç”Ÿæˆå®£è¨€';
                btnMain.textContent = 'ğŸ¤– ç”Ÿæˆå®£è¨€';
            }
        }

        // åŠ è½½æ¨¡æ¿
        function loadTemplate() {
            const template = `æˆ‘ä»¬ï¼Œ[å‚ä¸å›½å®¶åˆ—è¡¨]çš„ä»£è¡¨ï¼Œåœ¨WTOæ¡†æ¶ä¸‹å°±[è®®é¢˜]è¿›è¡Œäº†æ·±å…¥è®¨è®ºå’Œç£‹å•†ï¼Œè¾¾æˆä»¥ä¸‹å…±è¯†ï¼š

ä¸€ã€[ä¸»è¦è®®é¢˜ä¸€]

[å…·ä½“å†…å®¹å’Œæªæ–½]

äºŒã€[ä¸»è¦è®®é¢˜äºŒ]

[å…·ä½“å†…å®¹å’Œæªæ–½]

ä¸‰ã€[ä¸»è¦è®®é¢˜ä¸‰]

[å…·ä½“å†…å®¹å’Œæªæ–½]

å››ã€å®æ–½è·¯å¾„

[å®æ–½è®¡åˆ’å’Œæ—¶é—´å®‰æ’]

æˆ‘ä»¬å‘¼åæ‰€æœ‰WTOæˆå‘˜ç§¯æå‚ä¸è¿™ä¸€é‡è¦è¿›ç¨‹ï¼Œå…±åŒç»´æŠ¤å¤šè¾¹è´¸æ˜“ä½“ç³»ã€‚

[ç­¾ç½²å›½å®¶]
[æ—¥æœŸ]`;
            
            if (confirm('åŠ è½½æ¨¡æ¿å°†è¦†ç›–å½“å‰å†…å®¹ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                document.getElementById('declaration-content').value = template;
                updateWordCount();
                showAlert('æ ‡å‡†æ¨¡æ¿å·²åŠ è½½', 'success');
            }
        }

        // æ’å…¥æ¨¡æ¿ç‰‡æ®µ
        function insertTemplate(type) {
            const textarea = document.getElementById('declaration-content');
            const templates = {
                'opening': 'æˆ‘ä»¬ï¼Œ[å›½å®¶åç§°]çš„ä»£è¡¨ï¼Œåœ¨WTOæ¡†æ¶ä¸‹å°±[è®®é¢˜]è¿›è¡Œäº†æ·±å…¥è®¨è®ºå’Œç£‹å•†ï¼Œè¾¾æˆä»¥ä¸‹å…±è¯†ï¼š\n\n',
                'closing': '\n\næˆ‘ä»¬å‘¼åæ‰€æœ‰WTOæˆå‘˜ç§¯æå‚ä¸è¿™ä¸€é‡è¦è¿›ç¨‹ï¼Œå…±åŒç»´æŠ¤å’Œå®Œå–„å¤šè¾¹è´¸æ˜“ä½“ç³»ã€‚\n\n[ç­¾ç½²å›½å®¶]\n[æ—¥æœŸ]'
            };
            
            const template = templates[type];
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(textarea.selectionEnd);
            
            textarea.value = textBefore + template + textAfter;
            textarea.focus();
            textarea.setSelectionRange(cursorPos + template.length, cursorPos + template.length);
            
            updateWordCount();
        }

        // æ¸…ç©ºå†…å®¹
        function clearContent() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
                document.getElementById('declaration-content').value = '';
                updateWordCount();
                showAlert('å†…å®¹å·²æ¸…ç©º', 'success');
            }
        }

        // ä¿å­˜è‰ç¨¿
        function saveDraft() {
            const content = document.getElementById('declaration-content').value;
            localStorage.setItem(`declaration-draft-${sessionId}`, content);
            showAlert('å®£è¨€è‰ç¨¿å·²ä¿å­˜', 'success');
        }

        // é¢„è§ˆå®£è¨€
        function previewDeclaration() {
            const content = document.getElementById('declaration-content').value;
            if (!content.trim()) {
                showAlert('è¯·å…ˆç”Ÿæˆæˆ–ç¼–å†™å®£è¨€å†…å®¹', 'error');
                return;
            }
            
            // æ‰“å¼€æ–°çª—å£é¢„è§ˆ
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>å…±åŒå®£è¨€é¢„è§ˆ</title>
                    <style>
                        body { font-family: 'Microsoft YaHei', Arial, sans-serif; padding: 40px; line-height: 1.8; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #ccc; padding-bottom: 20px; }
                        .content { white-space: pre-wrap; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>WTOæ¨¡æ‹Ÿè°ˆåˆ¤å…±åŒå®£è¨€</h1>
                        <p>ä¼šè®®ç¼–å·ï¼š${sessionId} | å§”å‘˜ä¼šï¼š${committeeName}</p>
                    </div>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
        }

        // ç¡®è®¤å®šç¨¿
        async function finalizeDeclaration() {
            const content = document.getElementById('declaration-content').value;
            if (!content.trim()) {
                showAlert('è¯·å…ˆç”Ÿæˆæˆ–ç¼–å†™å®£è¨€å†…å®¹', 'error');
                return;
            }
            
            if (confirm('ç¡®è®¤å®šç¨¿åå°†æ— æ³•ä¿®æ”¹ï¼Œç¡®å®šè¦å®šç¨¿å—ï¼Ÿ')) {
                try {
                    const response = await fetch('/api/finalize_declaration', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            declaration: content
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        declarationStatus = 'finalized';
                        document.getElementById('declaration-status-text').textContent = 'å·²ç¡®è®¤å®šç¨¿';
                        document.getElementById('current-status').textContent = 'å®šç¨¿';
                        
                        // ç¦ç”¨ç¼–è¾‘åŠŸèƒ½
                        document.getElementById('declaration-content').readOnly = true;
                        document.querySelectorAll('.editor-toolbar .btn').forEach(btn => {
                            btn.disabled = true;
                        });
                        document.getElementById('generate-btn').disabled = true;
                        document.getElementById('generate-btn-main').disabled = true;
                        
                        showAlert('å…±åŒå®£è¨€å·²ç¡®è®¤å®šç¨¿ï¼', 'success');
                    } else {
                        showAlert(data.message || 'å®šç¨¿å¤±è´¥', 'error');
                    }
                    
                } catch (error) {
                    console.error('å®šç¨¿å¤±è´¥:', error);
                    showAlert('å®šç¨¿æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                }
            }
        }

        // å¯¼å‡ºPDF
        async function exportPDF() {
            const content = document.getElementById('declaration-content').value;
            if (!content.trim()) {
                showAlert('è¯·å…ˆç”Ÿæˆæˆ–ç¼–å†™å®£è¨€å†…å®¹', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/export_declaration_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        declaration: content,
                        committee_name: committeeName,
                        agenda: agenda
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `å…±åŒå®£è¨€_${sessionId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showAlert('PDFå·²å¯¼å‡º', 'success');
                } else {
                    showAlert('PDFå¯¼å‡ºå¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
                showAlert('å¯¼å‡ºæ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }

        // åˆ†äº«å®£è¨€
        function shareDeclaration() {
            const content = document.getElementById('declaration-content').value;
            if (!content.trim()) {
                showAlert('è¯·å…ˆç”Ÿæˆæˆ–ç¼–å†™å®£è¨€å†…å®¹', 'error');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: 'WTOå…±åŒå®£è¨€',
                    text: content.substring(0, 200) + '...',
                    url: window.location.href
                });
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(content).then(() => {
                    showAlert('å®£è¨€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                });
            }
        }

        // åˆ·æ–°æ–‡ä»¶
        async function refreshFiles() {
            showAlert('æ­£åœ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨...', 'success');
            await loadPassedFiles();
            showAlert('æ–‡ä»¶åˆ—è¡¨å·²åˆ·æ–°', 'success');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('passed-files-count').textContent = passedFiles.length;
            document.getElementById('participating-countries').textContent = passedFiles.length; // å‡è®¾æ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªå›½å®¶
            document.getElementById('source-files-count').textContent = `åŸºäº${passedFiles.length}ä¸ªé€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶`;
        }

        // æ›´æ–°å­—æ•°ç»Ÿè®¡
        function updateWordCount() {
            const content = document.getElementById('declaration-content').value;
            const wordCount = content.length;
            document.getElementById('declaration-words').textContent = wordCount.toLocaleString();
        }

        // è¿”å›æŠ•ç¥¨ç›‘æ§
        function goBack() {
            const url = `/chairman-vote-monitoring?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
            window.location.href = url;
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>

