<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»å¸­é€‰æ‹©ï½œWTO æ¨¡æ‹Ÿè°ˆåˆ¤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .chairman-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            margin: 0 0 8px;
            font-size: 28px;
            color: #2c3e50;
        }
        
        .header p {
            margin: 0;
            color: #6b7280;
            font-size: 16px;
        }
        
        .form-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .session-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .session-info h3 {
            margin: 0 0 8px;
            color: #1e293b;
            font-size: 18px;
        }
        
        .session-info p {
            margin: 0;
            color: #64748b;
        }
        
        .chairman-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
            padding: 4px;
        }
        
        .chairman-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
        }
        
        .chairman-item:hover {
            border-color: #3b82f6;
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .chairman-item.selected {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .chairman-flag {
            width: 40px;
            height: 30px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .chairman-name {
            font-weight: 500;
            color: #111827;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc2626;
        }
        
        .selected-info {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }
        
        .selected-info.show {
            display: block;
        }
        
        .selected-chairman {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .selected-chairman .chairman-flag {
            width: 48px;
            height: 36px;
        }
        
        .selected-chairman .chairman-name {
            font-size: 20px;
            font-weight: 600;
            color: #065f46;
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }
        
        .form-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .form-actions .btn {
            flex: 1;
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-left">
            <h1>WTO æ¨¡æ‹Ÿè°ˆåˆ¤ - ä¸»å¸­é€‰æ‹©</h1>
        </div>
    </header>

    <div class="chairman-container">
        <div class="header">
            <h1>ä¸»å¸­æ§åˆ¶å°</h1>
            <p>æ‚¨å·²ä½œä¸ºä¸»å¸­èº«ä»½è¿›å…¥ä¼šè®®ï¼Œä»¥ä¸‹æ˜¯å®æ—¶å‚ä¸çš„å›½å®¶</p>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div id="alert" class="alert"></div>

        <!-- ä¼šè®®ä¿¡æ¯ -->
        <div class="session-info">
            <h3>ä¼šè®®ä¿¡æ¯</h3>
            <p>ä¼šè®®ç¼–å·ï¼š<strong id="session-display">{{ session_id or 'æœªè®¾ç½®' }}</strong></p>
            <p>å§”å‘˜ä¼šï¼š<strong id="committee-display">{{ committee_name or 'æœªè®¾ç½®' }}</strong></p>
            <p>è®®é¢˜ï¼š<strong id="agenda-display">{{ agenda or 'æœªè®¾ç½®' }}</strong></p>
        </div>

        <!-- ä¼šè®®åˆ›å»º/åŠ è½½è¡¨å• -->
        <div class="form-section">
            <h3>ä¼šè®®è®¾ç½®</h3>
            <div class="form-group">
                <label for="session-input">ä¼šè®®ç¼–å·</label>
                <input type="text" id="session-input" placeholder="è¯·è¾“å…¥5ä½æ•°å­—ä¼šè®®ç¼–å·" value="{{ session_id or '' }}" maxlength="5">
                <small class="form-hint">ä¼šè®®ç¼–å·ç”¨äºä¸ä¼šå›½åŠ å…¥ä¼šè®®</small>
            </div>
            
            <div class="form-group">
                <label for="committee-input">å§”å‘˜ä¼šåç§°</label>
                <input type="text" id="committee-input" placeholder="è¯·è¾“å…¥å§”å‘˜ä¼šåç§°" value="{{ committee_name or '' }}">
            </div>
            
            <div class="form-group">
                <label for="agenda-input">è®®é¢˜</label>
                <input type="text" id="agenda-input" placeholder="è¯·è¾“å…¥è®®é¢˜" value="{{ agenda or '' }}">
            </div>
            
            <div class="form-actions">
                <button type="button" id="create-meeting-btn" class="btn btn-primary">åˆ›å»ºæ–°ä¼šè®®</button>
                <button type="button" id="load-session-btn" class="btn btn-secondary">åŠ è½½ç°æœ‰ä¼šè®®</button>
            </div>
        </div>

        <!-- ä¸»å¸­èº«ä»½ç¡®è®¤ -->
        <div class="selected-info" id="chairman-info">
            <div class="selected-chairman">
                <span class="chairman-name">ğŸ‘‘ æ‚¨å·²ä½œä¸ºä¸»å¸­èº«ä»½è¿›å…¥ä¼šè®®</span>
            </div>
        </div>

        <!-- å‚ä¸å›½å®¶åˆ—è¡¨ -->
        <div class="form-section">
            <h3>å‚ä¸å›½å®¶åˆ—è¡¨</h3>
            <div id="participants-container">
                <div class="loading">æ­£åœ¨åŠ è½½å‚ä¸å›½å®¶...</div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="actions">
            <button class="btn btn-secondary" onclick="history.back()">è¿”å›</button>
            <button class="btn btn-primary" id="continue-btn">ç»§ç»­è®¾ç½®æŠ•ç¥¨æœºåˆ¶</button>
        </div>
    </div>

    <script>
        let allCountries = [];
        let sessionId = "{{ session_id or '' }}";
        let committeeName = "{{ committee_name or '' }}";
        let agenda = "{{ agenda or '' }}";

        const elements = {
            sessionInput: document.getElementById('session-input'),
            committeeInput: document.getElementById('committee-input'),
            agendaInput: document.getElementById('agenda-input'),
            loadSessionBtn: document.getElementById('load-session-btn'),
            participantsContainer: document.getElementById('participants-container'),
            continueBtn: document.getElementById('continue-btn'),
            chairmanInfo: document.getElementById('chairman-info'),
            sessionDisplay: document.getElementById('session-display'),
            committeeDisplay: document.getElementById('committee-display'),
            agendaDisplay: document.getElementById('agenda-display'),
            alert: document.getElementById('alert')
        };

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'success') {
            elements.alert.textContent = message;
            elements.alert.className = `alert alert-${type} show`;
            setTimeout(() => {
                elements.alert.classList.remove('show');
            }, 5000);
        }

        // åŠ è½½ä¼šè®®ä¿¡æ¯
        async function loadSessionInfo() {
            const sessionIdInput = elements.sessionInput.value.trim();
            
            if (!sessionIdInput) {
                showAlert('è¯·è¾“å…¥ä¼šè®®ç¼–å·', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/get_session_info?session_id=${encodeURIComponent(sessionIdInput)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    sessionId = sessionIdInput;
                    committeeName = data.data.committee_name || '';
                    agenda = data.data.agenda || '';
                    
                    // æ›´æ–°æ˜¾ç¤º
                    elements.sessionDisplay.textContent = sessionId;
                    elements.committeeDisplay.textContent = committeeName;
                    elements.agendaDisplay.textContent = agenda;
                    elements.committeeInput.value = committeeName;
                    elements.agendaInput.value = agenda;
                    
                    showAlert('ä¼šè®®ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
                    
                    // åŠ è½½å‚ä¸å›½å®¶åˆ—è¡¨
                    await loadParticipants();
                    
                    // å¼€å§‹å®æ—¶åˆ·æ–°
                    startRealtimeRefresh();
                } else {
                    showAlert('åŠ è½½ä¼šè®®ä¿¡æ¯å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè®®ä¿¡æ¯å¤±è´¥:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'error');
            }
        }

        // åŠ è½½å‚ä¸å›½å®¶åˆ—è¡¨ï¼ˆåªåŠ è½½å·²é€šè¿‡ä¸ä¼šå›½é—¨æˆ·åŠ å…¥çš„å›½å®¶ï¼‰
        async function loadParticipants() {
            try {
                const response = await fetch(`/api/countries?session_id=${encodeURIComponent(sessionId)}&only_participants=true`);
                const data = await response.json();
                
                if (data.code === 200) {
                    allCountries = data.data || [];
                    renderParticipants(allCountries);
                } else {
                    showError('åŠ è½½å‚ä¸å›½å®¶å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½å‚ä¸å›½å®¶å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
            }
        }

        // æ¸²æŸ“å‚ä¸å›½å®¶åˆ—è¡¨
        function renderParticipants(countries) {
            if (countries.length === 0) {
                elements.participantsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;"><div style="font-size: 48px; margin-bottom: 16px;">ğŸŒ</div><div>æš‚æ— å‚ä¸å›½å®¶</div><div style="margin-top: 8px; font-size: 14px;">ç­‰å¾…ä¸ä¼šå›½é€šè¿‡é—¨æˆ·åŠ å…¥ä¼šè®®...</div></div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'chairman-grid';

            countries.forEach(country => {
                const item = document.createElement('div');
                item.className = 'chairman-item';
                item.dataset.countryId = country.id;
                
                item.innerHTML = `
                    <img class="chairman-flag" src="${country.flag_url}" alt="${country.name}" onerror="this.src='/static/flags/default.png'">
                    <span class="chairman-name">${country.name}</span>
                `;

                // ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼Œè¿™é‡Œåªæ˜¯æ˜¾ç¤ºå‚ä¸å›½å®¶
                grid.appendChild(item);
            });

            elements.participantsContainer.innerHTML = '';
            elements.participantsContainer.appendChild(grid);
        }

        // ç»§ç»­åˆ°æŠ•ç¥¨æœºåˆ¶è®¾ç½®
        async function continueToVotingMechanism() {
            if (!sessionId) {
                showAlert('è¯·å…ˆåŠ è½½ä¼šè®®ä¿¡æ¯', 'error');
                return;
            }
            
            try {
                // å…ˆæ¨è¿›ä¼šè®®é˜¶æ®µåˆ°rollcall
                const advanceResponse = await fetch('/api/meeting/advance_phase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        target_phase: 'rollcall'
                    })
                });
                
                const advanceData = await advanceResponse.json();
                if (advanceData.code === 200) {
                    console.log('ä¼šè®®é˜¶æ®µå·²æ¨è¿›åˆ°ç‚¹åé˜¶æ®µ');
                } else {
                    console.warn('æ¨è¿›ä¼šè®®é˜¶æ®µå¤±è´¥:', advanceData.message);
                }
            } catch (error) {
                console.error('æ¨è¿›ä¼šè®®é˜¶æ®µæ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
            
            // ç›´æ¥è·³è½¬åˆ°æŠ•ç¥¨æœºåˆ¶è®¾ç½®é¡µé¢ï¼ˆç°åœ¨ä¼šé‡å®šå‘åˆ°ç‚¹åé¡µé¢ï¼‰
            const url = `/voting-mechanism?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
            window.location.href = url;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            elements.participantsContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        // åˆ›å»ºæ–°ä¼šè®®
        async function createNewMeeting() {
            const sessionInput = document.getElementById('session-input').value.trim();
            const committeeInput = document.getElementById('committee-input').value.trim();
            const agendaInput = document.getElementById('agenda-input').value.trim();
            
            if (!sessionInput || !committeeInput || !agendaInput) {
                showAlert('è¯·å¡«å†™æ‰€æœ‰å¿…è¦ä¿¡æ¯', 'error');
                return;
            }
            
            if (sessionInput.length !== 5 || !/^\d+$/.test(sessionInput)) {
                showAlert('ä¼šè®®ç¼–å·å¿…é¡»æ˜¯5ä½æ•°å­—', 'error');
                return;
            }
            
            try {
                // æ£€æŸ¥ä¼šè®®æ˜¯å¦å·²å­˜åœ¨
                const checkResponse = await fetch(`/api/get_session_info?session_id=${encodeURIComponent(sessionInput)}`);
                const checkData = await checkResponse.json();
                
                if (checkData.code === 200) {
                    showAlert('ä¼šè®®ç¼–å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ç¼–å·æˆ–é€‰æ‹©"åŠ è½½ç°æœ‰ä¼šè®®"', 'error');
                    return;
                }
                
                // åˆ›å»ºæ–°ä¼šè®®
                const createResponse = await fetch('/api/create_new_session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionInput,
                        committee_name: committeeInput,
                        agenda: agendaInput,
                        mechanism_name: '',
                        mechanism_requirement: ''
                    })
                });
                
                const createData = await createResponse.json();
                
                if (createData.code === 200) {
                    showAlert('ä¼šè®®åˆ›å»ºæˆåŠŸï¼ç­‰å¾…ä¸ä¼šå›½åŠ å…¥...', 'success');
                    sessionId = sessionInput;
                    committeeName = committeeInput;
                    agenda = agendaInput;
                    
                    // æ›´æ–°æ˜¾ç¤º
                    document.getElementById('session-display').textContent = sessionId;
                    document.getElementById('committee-display').textContent = committeeName;
                    document.getElementById('agenda-display').textContent = agenda;
                    
                    // åŠ è½½å‚ä¸å›½å®¶ï¼ˆæ–°ä¼šè®®åº”è¯¥ä¸ºç©ºï¼‰
                    await loadParticipants();
                    
                    // å¼€å§‹å®æ—¶åˆ·æ–°
                    startRealtimeRefresh();
                } else {
                    showAlert('åˆ›å»ºä¼šè®®å¤±è´¥ï¼š' + (createData.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºä¼šè®®å¤±è´¥:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'error');
            }
        }

        // å¼€å§‹å®æ—¶åˆ·æ–°å‚ä¸å›½åˆ—è¡¨
        let refreshInterval = null;
        function startRealtimeRefresh() {
            // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡å‚ä¸å›½åˆ—è¡¨
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(() => {
                if (sessionId) {
                    loadParticipants();
                }
            }, 3000);
        }

        function stopRealtimeRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºç©ºçš„å‚ä¸å›½åˆ—è¡¨
            renderParticipants([]);
            
            // å¦‚æœå·²æœ‰session_idï¼Œè‡ªåŠ¨åŠ è½½ä¼šè®®ä¿¡æ¯
            if (sessionId) {
                loadSessionInfo();
                // å¼€å§‹å®æ—¶åˆ·æ–°
                startRealtimeRefresh();
            }
            
            elements.loadSessionBtn.addEventListener('click', loadSessionInfo);
            
            elements.continueBtn.addEventListener('click', continueToVotingMechanism);
            
            // æ·»åŠ åˆ›å»ºæ–°ä¼šè®®æŒ‰é’®äº‹ä»¶
            document.getElementById('create-meeting-btn').addEventListener('click', createNewMeeting);

            // é¡µé¢å¸è½½æ—¶åœæ­¢åˆ·æ–°
            window.addEventListener('beforeunload', stopRealtimeRefresh);
        });
    </script>
</body>
</html>
