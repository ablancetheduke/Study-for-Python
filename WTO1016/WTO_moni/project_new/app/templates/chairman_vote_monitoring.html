<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»å¸­æŠ•ç¥¨ç›‘æ§ï½œWTO æ¨¡æ‹Ÿè°ˆåˆ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left h1 {
            text-align: center;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 8px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .vote-info {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .vote-info h3 {
            margin: 0 0 16px;
            color: #1e293b;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .info-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        .vote-mechanism {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vote-mechanism strong {
            color: #065f46;
        }

        .vote-status-bar {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        .refresh-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #6b7280;
        }

        .result-indicator {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-indicator.passed {
            background: #d1fae5;
            border-color: #a7f3d0;
        }

        .result-indicator.failed {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .result-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .result-detail {
            font-size: 14px;
            color: #6b7280;
        }

        /* æŠ•ç¥¨çŸ©é˜µæ ·å¼ */
        .vote-matrix-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .panel-title-text {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .vote-matrix-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .matrix-note {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0c4a6e;
        }

        .vote-matrix {
            display: table;
            width: 100%;
            border-collapse: separate;
            border-spacing: 2px;
            min-width: 800px;
        }

        .matrix-header,
        .matrix-row {
            display: table-row;
        }

        .matrix-cell {
            display: table-cell;
            padding: 12px 8px;
            text-align: center;
            vertical-align: middle;
            border-radius: 6px;
            font-size: 14px;
            min-width: 80px;
        }

        .matrix-cell.corner {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            color: #374151;
        }

        .matrix-cell.file-header {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            font-weight: 600;
            color: #1e40af;
        }

        .matrix-cell.country-header {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            font-weight: 600;
            color: #166534;
            min-width: 100px;
        }

        .matrix-cell.progress-header {
            background: #fef3c7;
            border: 1px solid #fde68a;
            font-weight: 600;
            color: #92400e;
        }

        .file-flag,
        .country-flag {
            width: 20px;
            height: 15px;
            border-radius: 2px;
            margin-right: 6px;
            vertical-align: middle;
        }

        .vote-cell {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .vote-cell:hover {
            transform: scale(1.05);
        }

        .vote-cell.voted.agree {
            background: #d1fae5;
            border-color: #a7f3d0;
            color: #065f46;
        }

        .vote-cell.voted.disagree {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .vote-cell.voted.abstain {
            background: #fef3c7;
            border-color: #fde68a;
            color: #92400e;
        }

        .vote-cell.pending {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #6b7280;
            animation: pending-pulse 2s infinite;
        }

        .vote-cell.self {
            background: #e5e7eb;
            border-color: #9ca3af;
            color: #6b7280;
            cursor: not-allowed;
        }

        @keyframes pending-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .progress-cell {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px;
        }

        .progress-text {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .mini-progress {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        .stats-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .controls {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .vote-matrix {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-left">
            <h1>WTO æ¨¡æ‹Ÿè°ˆåˆ¤ - ä¸»å¸­æŠ•ç¥¨ç›‘æ§</h1>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <h1>ğŸ—³ï¸ ä¸»å¸­æŠ•ç¥¨ç›‘æ§</h1>
            <p>å®æ—¶ç›‘æ§å„å›½æŠ•ç¥¨çŠ¶æ€ï¼Œç®¡ç†æŠ•ç¥¨æµç¨‹</p>
        </div>

        <!-- æŠ•ç¥¨ä¿¡æ¯ -->
        <div class="vote-info">
            <h3>ğŸ“‹ æŠ•ç¥¨ä¿¡æ¯</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">ä¼šè®®ç¼–å·ï¼š</span>
                    <span class="info-value" id="session-display">{{ session_id or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å§”å‘˜ä¼šï¼š</span>
                    <span class="info-value" id="committee-display">{{ committee_name or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">è®®é¢˜ï¼š</span>
                    <span class="info-value" id="agenda-display">{{ agenda or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æŠ•ç¥¨å¼€å§‹ï¼š</span>
                    <span class="info-value" id="vote-start-time">-</span>
                </div>
            </div>
            <div class="vote-mechanism">
                <strong>æŠ•ç¥¨æœºåˆ¶ï¼š</strong>
                <span id="mechanism-name">{{ mechanism_name or 'åå•†ä¸€è‡´' }}</span>
                <span style="color: #6b7280; margin-left: 10px;" id="mechanism-requirement">({{ mechanism_requirement or 'è¦æ±‚ï¼š100% åŒæ„' }})</span>
            </div>
        </div>

        <!-- æŠ•ç¥¨è¿›åº¦çŠ¶æ€ -->
        <div class="vote-status-bar">
            <div class="status-header">
                <div class="status-title">æŠ•ç¥¨è¿›åº¦</div>
                <div class="auto-refresh">
                    <div class="refresh-dot"></div>
                    <span>æ¯5ç§’è‡ªåŠ¨åˆ·æ–°</span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">æ­£åœ¨åŠ è½½æŠ•ç¥¨æ•°æ®...</div>
        </div>

        <!-- æŠ•ç¥¨ç»“æœé¢„è§ˆ -->
        <div class="result-indicator" id="result-indicator">
            <div class="result-text" id="result-text">æŠ•ç¥¨å‡†å¤‡ä¸­...</div>
            <div class="result-detail" id="result-detail">ç­‰å¾…åŠ è½½æŠ•ç¥¨æ•°æ®</div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div id="alert" class="alert"></div>

        <!-- æŠ•ç¥¨çŸ©é˜µè¡¨æ ¼ -->
        <div class="vote-matrix-section">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="panel-icon">ğŸ“Š</div>
                    <div class="panel-title-text">æŠ•ç¥¨å®Œæˆæƒ…å†µçŸ©é˜µ</div>
                </div>
                <div class="panel-actions">
                    <button class="btn btn-secondary btn-small" onclick="refreshVoteData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    
                    <button class="btn btn-primary btn-small" onclick="exportVoteReport()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
                </div>
            </div>
            
            <div class="vote-matrix-container">
                <div class="matrix-note">
                    <span>ğŸ“ è¯´æ˜ï¼šæ¨ªå‘ä¸ºæŠ•ç¥¨å›½å®¶ï¼Œçºµå‘ä¸ºè¢«æŠ•ç¥¨æ–‡ä»¶ï¼Œç»¿è‰²è¡¨ç¤ºåŒæ„ï¼Œçº¢è‰²è¡¨ç¤ºåå¯¹ï¼Œæ©™è‰²è¡¨ç¤ºå¼ƒæƒï¼Œç°è‰²è¡¨ç¤ºæœªæŠ•ç¥¨</span>
                </div>
                
                <div class="vote-matrix" id="vote-matrix">
                    <div class="matrix-header">
                        <div class="matrix-cell corner">æŠ•ç¥¨å›½ \ æ–‡ä»¶</div>
                        <div class="matrix-cell progress-header">å®Œæˆåº¦</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->


        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="buttons">
                <button class="btn btn-primary" onclick="refreshVoteData()">
                    ğŸ”„ æ‰‹åŠ¨åˆ·æ–°
                </button>
                <button class="btn btn-danger" onclick="forceEndVoting()" style="background: linear-gradient(135deg, #dc2626, #b91c1c);">
                    ğŸ›‘ å¼ºåˆ¶ç»“æŸæŠ•ç¥¨
                </button>
                <button class="btn btn-success" onclick="completeVoting()" id="complete-btn" style="background: linear-gradient(135deg, #059669, #047857);">
                    âœ… å®ŒæˆæŠ•ç¥¨
                </button>
                <button class="btn btn-secondary" onclick="goBack()">
                    â† è¿”å›åŠ¨è®®ç®¡ç†
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let sessionId = "{{ session_id or '' }}";
        let committeeName = "{{ committee_name or '' }}";
        let agenda = "{{ agenda or '' }}";
        let mechanismName = "{{ mechanism_name or 'åå•†ä¸€è‡´' }}";
        let mechanismRequirement = "{{ mechanism_requirement or 'è¦æ±‚ï¼š100% åŒæ„' }}";
        
        let voteMatrix = {};
        let countries = [];
        let files = [];
        let autoRefreshInterval;

        // DOM å…ƒç´ 
        const alert = document.getElementById('alert');
        const voteMatrixEl = document.getElementById('vote-matrix');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const resultIndicator = document.getElementById('result-indicator');
        const resultText = document.getElementById('result-text');
        const resultDetail = document.getElementById('result-detail');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¸»å¸­æŠ•ç¥¨ç›‘æ§é¡µé¢å·²åŠ è½½');
            console.log('ä¼šè®®ä¿¡æ¯:', { sessionId, committeeName, agenda });
            
            // è®¾ç½®æŠ•ç¥¨å¼€å§‹æ—¶é—´
            document.getElementById('vote-start-time').textContent = new Date().toLocaleString();
            
            loadVoteData();
            startAutoRefresh();
        });

        // åŠ è½½æŠ•ç¥¨æ•°æ®
        async function loadVoteData() {
            try {
                // åŠ è½½åˆ°åœºå›½å®¶
                await loadArrivedCountries();
                
                // åŠ è½½æäº¤çš„æ–‡ä»¶
                await loadSubmittedFiles();
                
                // åŠ è½½æŠ•ç¥¨è¯¦æƒ…
                await loadVoteDetails();
                
                // æ¸²æŸ“æŠ•ç¥¨çŸ©é˜µ
                renderVoteMatrix();
                updateAllStats();
                
            } catch (error) {
                console.error('åŠ è½½æŠ•ç¥¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½åˆ°åœºå›½å®¶
        async function loadArrivedCountries() {
            const response = await fetch(`/api/rollcall/arrived?session_id=${encodeURIComponent(sessionId)}`);
            const data = await response.json();
            
            if (data.code === 200) {
                const arrivedIds = data.data || [];
                
                // è·å–å›½å®¶è¯¦ç»†ä¿¡æ¯
                const countriesResponse = await fetch(`/api/countries?session_id=${encodeURIComponent(sessionId)}`);
                const countriesData = await countriesResponse.json();
                
                if (countriesData.code === 200) {
                    const allCountriesData = countriesData.data || [];
                    countries = allCountriesData.filter(country => 
                        arrivedIds.includes(country.id)
                    );
                    console.log('åˆ°åœºå›½å®¶æ•°é‡:', countries.length);
                }
            }
        }

        // åŠ è½½æäº¤çš„æ–‡ä»¶
        async function loadSubmittedFiles() {
            const response = await fetch(`/api/submissions?session_id=${encodeURIComponent(sessionId)}`);
            const data = await response.json();
            
            if (data.code === 200) {
                const submissions = data.data || [];
                
                // è·å–æ–‡ä»¶å¯¹åº”çš„å›½å®¶ä¿¡æ¯
                files = [];
                for (const submission of submissions) {
                    const country = countries.find(c => c.id === submission.country_id);
                    if (country) {
                        files.push({
                            id: submission.country_id,
                            country_name: country.name,
                            flag_url: country.flag_url,
                            filename: submission.file_name || 'æ–‡æœ¬æäº¤',
                            created_at: submission.created_at
                        });
                    }
                }
                console.log('æäº¤æ–‡ä»¶æ•°é‡:', files.length);
            }
        }

        // åŠ è½½æŠ•ç¥¨è¯¦æƒ…
        async function loadVoteDetails() {
            try {
                // ä½¿ç”¨ä¸æŠ•ç¥¨æäº¤ç›¸åŒçš„æ•°æ®åº“è¿æ¥æ–¹å¼
                const response = await fetch(`/api/get_file_vote_details_by_session?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const voteDetails = data.data || [];
                    
                    // æ„å»ºæŠ•ç¥¨çŸ©é˜µ
                    voteMatrix = {};
                    countries.forEach(country => {
                        voteMatrix[country.id] = {};
                        files.forEach(file => {
                            if (file.id !== country.id) { // ä¸èƒ½ç»™è‡ªå·±çš„æ–‡ä»¶æŠ•ç¥¨
                                voteMatrix[country.id][file.id] = null;
                            }
                        });
                    });
                    
                    // å¡«å…¥å·²æœ‰çš„æŠ•ç¥¨æ•°æ®
                    voteDetails.forEach(vote => {
                        if (voteMatrix[vote.country_id] && voteMatrix[vote.country_id][vote.file_id] !== undefined) {
                            voteMatrix[vote.country_id][vote.file_id] = vote.vote_result;
                        }
                    });
                    
                    console.log('æŠ•ç¥¨çŸ©é˜µå·²æ„å»º');
                } else {
                    console.warn('è·å–æŠ•ç¥¨è¯¦æƒ…å¤±è´¥:', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½æŠ•ç¥¨è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“æŠ•ç¥¨çŸ©é˜µ
        function renderVoteMatrix() {
            if (countries.length === 0 || files.length === 0) {
                voteMatrixEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
                        <div>æš‚æ— æŠ•ç¥¨æ•°æ®</div>
                    </div>
                `;
                return;
            }

            // æ„å»ºè¡¨å¤´
            let headerHTML = '<div class="matrix-cell corner">æŠ•ç¥¨å›½ \\ æ–‡ä»¶</div>';
            files.forEach(file => {
                headerHTML += `
                    <div class="matrix-cell file-header">
                        <img class="file-flag" src="${file.flag_url}" alt="${file.country_name}">
                        <span>${file.country_name}æ–‡ä»¶</span>
                    </div>
                `;
            });
            headerHTML += '<div class="matrix-cell progress-header">å®Œæˆåº¦</div>';

            // æ„å»ºæ•°æ®è¡Œ
            let rowsHTML = '';
            countries.forEach(country => {
                let rowHTML = `
                    <div class="matrix-row">
                        <div class="matrix-cell country-header">
                            <img class="country-flag" src="${country.flag_url}" alt="${country.name}">
                            <span>${country.name}</span>
                        </div>
                `;

                let completedVotes = 0;
                let totalVotes = 0;

                files.forEach(file => {
                    if (file.id === country.id) {
                        // è‡ªå·±çš„æ–‡ä»¶
                        rowHTML += '<div class="matrix-cell vote-cell self">-</div>';
                    } else {
                        totalVotes++;
                        const vote = voteMatrix[country.id] ? voteMatrix[country.id][file.id] : null;
                        
                        if (vote) {
                            completedVotes++;
                            const voteClass = `voted ${vote}`;
                            const voteIcon = vote === 'agree' ? 'âœ…' : vote === 'disagree' ? 'âŒ' : 'âšª';
                            const voteTitle = `${country.name}å¯¹${file.country_name}æ–‡ä»¶ï¼š${getVoteText(vote)}`;
                            
                            rowHTML += `<div class="matrix-cell vote-cell ${voteClass}" title="${voteTitle}">${voteIcon}</div>`;
                        } else {
                            rowHTML += `<div class="matrix-cell vote-cell pending" title="${country.name}å¯¹${file.country_name}æ–‡ä»¶ï¼šæœªæŠ•ç¥¨">â³</div>`;
                        }
                    }
                });

                // è¿›åº¦åˆ—
                const progressPercentage = totalVotes > 0 ? Math.round((completedVotes / totalVotes) * 100) : 0;
                rowHTML += `
                    <div class="matrix-cell progress-cell">
                        <span class="progress-text">${completedVotes}/${totalVotes}</span>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                </div>
                `;

                rowsHTML += rowHTML;
            });

            voteMatrixEl.innerHTML = `
                <div class="matrix-header">${headerHTML}</div>
                ${rowsHTML}
            `;
        }

        // è·å–æŠ•ç¥¨æ–‡æœ¬
        function getVoteText(voteType) {
            const texts = {
                'agree': 'åŒæ„',
                'disagree': 'åå¯¹',
                'abstain': 'å¼ƒæƒ'
            };
            return texts[voteType] || 'æœªçŸ¥';
        }

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        function calculateStats() {
            let stats = {
                totalVotes: 0,
                completedVotes: 0,
                agreeVotes: 0,
                disagreeVotes: 0,
                abstainVotes: 0,
                completedCountries: 0
            };

            Object.keys(voteMatrix).forEach(countryId => {
                let countryCompleted = 0;
                let countryTotal = 0;
                
                Object.keys(voteMatrix[countryId]).forEach(fileId => {
                    countryTotal++;
                    stats.totalVotes++;
                    
                    const vote = voteMatrix[countryId][fileId];
                    if (vote !== null) {
                        countryCompleted++;
                        stats.completedVotes++;
                        
                        if (vote === 'agree') stats.agreeVotes++;
                        else if (vote === 'disagree') stats.disagreeVotes++;
                        else if (vote === 'abstain') stats.abstainVotes++;
                    }
                });
                
                if (countryCompleted === countryTotal) {
                    stats.completedCountries++;
                }
            });

            return stats;
        }

        // æ›´æ–°æ‰€æœ‰ç»Ÿè®¡æ˜¾ç¤º
        function updateAllStats() {
            const stats = calculateStats();
            
            // æ›´æ–°è¿›åº¦æ¡
            const percentage = stats.totalVotes > 0 ? Math.round((stats.completedVotes / stats.totalVotes) * 100) : 0;
            progressFill.style.width = percentage + '%';
            progressText.textContent = `å·²å®ŒæˆæŠ•ç¥¨ï¼š${stats.completedVotes}/${stats.totalVotes} (${percentage}%)`;
            
            // æ›´æ–°ç»“æœæŒ‡ç¤ºå™¨
            if (stats.completedVotes === stats.totalVotes) {
                if (stats.disagreeVotes === 0) {
                    resultIndicator.className = 'result-indicator passed';
                    resultText.textContent = 'ğŸ‰ æ‰€æœ‰æ–‡ä»¶æŠ•ç¥¨å®Œæˆï¼';
                    resultDetail.textContent = 'å¯ä»¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µ';
                } else {
                    resultIndicator.className = 'result-indicator';
                    resultText.textContent = 'ğŸ“Š æŠ•ç¥¨å®Œæˆ';
                    resultDetail.textContent = `åŒæ„ï¼š${stats.agreeVotes}ï¼Œåå¯¹ï¼š${stats.disagreeVotes}ï¼Œå¼ƒæƒï¼š${stats.abstainVotes}`;
                }
            } else {
                resultIndicator.className = 'result-indicator';
                resultText.textContent = 'æŠ•ç¥¨è¿›è¡Œä¸­...';
            }
            
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('total-countries').textContent = countries.length;
            document.getElementById('completed-votes').textContent = stats.completedVotes;
            document.getElementById('agree-votes').textContent = stats.agreeVotes;
            document.getElementById('disagree-votes').textContent = stats.disagreeVotes;
            document.getElementById('abstain-votes').textContent = stats.abstainVotes;
            document.getElementById('vote-progress').textContent = percentage + '%';
            
            // æ›´æ–°å®ŒæˆæŒ‰é’®çŠ¶æ€
            const completeBtn = document.getElementById('complete-btn');
            if (stats.completedVotes === stats.totalVotes) {
                completeBtn.disabled = false;
                completeBtn.textContent = 'âœ… å®ŒæˆæŠ•ç¥¨';
            } else {
                completeBtn.disabled = true;
                completeBtn.textContent = `âœ… å®ŒæˆæŠ•ç¥¨ (${stats.totalVotes - stats.completedVotes}ä¸ªå¾…æŠ•ç¥¨)`;
            }
        }

        // åˆ·æ–°æŠ•ç¥¨æ•°æ®
        async function refreshVoteData() {
            showSuccess('æ­£åœ¨åˆ·æ–°æŠ•ç¥¨æ•°æ®...');
            await loadVoteData();
            showSuccess('æŠ•ç¥¨æ•°æ®å·²åˆ·æ–°');
        }

        // åˆå§‹åŒ–æµ‹è¯•æ•°æ®
        async function initTestData() {
            try {
                if (confirm('ç¡®å®šè¦åˆå§‹åŒ–æµ‹è¯•æ•°æ®å—ï¼Ÿè¿™å°†åˆ›å»ºç¤ºä¾‹å›½å®¶å’Œæ–‡ä»¶æ•°æ®ã€‚')) {
                    showSuccess('æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•æ•°æ®...');
                    
                    const response = await fetch('/api/init_vote_data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        showSuccess('æµ‹è¯•æ•°æ®åˆå§‹åŒ–æˆåŠŸï¼Œæ­£åœ¨é‡æ–°åŠ è½½...');
                        setTimeout(async () => {
                            await loadVoteData();
                            showSuccess('æ•°æ®åŠ è½½å®Œæˆï¼');
                        }, 1000);
                    } else {
                        showError(data.message || 'åˆå§‹åŒ–å¤±è´¥');
                    }
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–æµ‹è¯•æ•°æ®å¤±è´¥:', error);
                showError('åˆå§‹åŒ–æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }

        // å‘é€æŠ•ç¥¨æé†’
        async function sendVoteReminder() {
            try {
                const stats = calculateStats();
                const pendingVotes = stats.totalVotes - stats.completedVotes;
                
                if (pendingVotes === 0) {
                    showError('æ‰€æœ‰æŠ•ç¥¨éƒ½å·²å®Œæˆï¼Œæ— éœ€å‘é€æé†’');
                    return;
                }

                const response = await fetch('/api/send_vote_reminder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                
                if (data.code === 200) {
                    showSuccess(`å·²å‘æœªå®ŒæˆæŠ•ç¥¨çš„å›½å®¶å‘é€æé†’ (${pendingVotes}ä¸ªå¾…æŠ•ç¥¨)`);
                } else {
                    showError(data.message || 'å‘é€æé†’å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å‘é€æŠ•ç¥¨æé†’å¤±è´¥:', error);
                showError('å‘é€æé†’æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }

        // å»¶é•¿æŠ•ç¥¨æ—¶é—´
        async function extendVoteDeadline() {
            const newDeadline = prompt('è¯·è¾“å…¥æ–°çš„æŠ•ç¥¨æˆªæ­¢æ—¶é—´ (æ ¼å¼ï¼šYYYY-MM-DD HH:MM)');
            if (newDeadline) {
                try {
                    const response = await fetch('/api/extend_vote_deadline', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            new_deadline: newDeadline
                        })
                    });

                    const data = await response.json();
                    
                    if (data.code === 200) {
                        showSuccess('æŠ•ç¥¨æˆªæ­¢æ—¶é—´å·²å»¶é•¿');
                    } else {
                        showError(data.message || 'å»¶é•¿æ—¶é—´å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('å»¶é•¿æŠ•ç¥¨æ—¶é—´å¤±è´¥:', error);
                    showError('å»¶é•¿æ—¶é—´æ—¶å‘ç”Ÿé”™è¯¯');
                }
            }
        }

        // å¼ºåˆ¶ç»“æŸæŠ•ç¥¨å¹¶ç›´æ¥è¿›å…¥å…±åŒå®£è¨€é˜¶æ®µ
        async function forceEndVoting() {
            const stats = calculateStats();
            const pendingVotes = stats.totalVotes - stats.completedVotes;

            if (pendingVotes > 0) {
                if (confirm(`è¿˜æœ‰${pendingVotes}ä¸ªæŠ•ç¥¨æœªå®Œæˆï¼Œç¡®å®šè¦å¼ºåˆ¶ç»“æŸæŠ•ç¥¨å—ï¼Ÿ\n\nâš ï¸ æ³¨æ„ï¼šå¼ºåˆ¶ç»“æŸåå°†è‡ªåŠ¨ï¼š\nâ€¢ æ ‡è®°æœªæŠ•ç¥¨ä¸ºå¼ƒæƒ\nâ€¢ è®¡ç®—æŠ•ç¥¨ç»“æœ\nâ€¢ å¤„ç†é€šè¿‡çš„æ–‡ä»¶\nâ€¢ ç›´æ¥è¿›å…¥å…±åŒå®£è¨€é˜¶æ®µ\n\nç¡®å®šç»§ç»­å—ï¼Ÿ`)) {
                    try {
                        showSuccess('æ­£åœ¨å¼ºåˆ¶ç»“æŸæŠ•ç¥¨å¹¶å®Œæˆæµç¨‹...');

                        const response = await fetch('/api/force_end_voting', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                session_id: sessionId
                            })
                        });

                        const data = await response.json();

                        if (data.code === 200) {
                            const passedCount = data.data.passed_files_count;
                            const uncompletedCount = data.data.uncompleted_count;

                            showSuccess(`âœ… æŠ•ç¥¨å¼ºåˆ¶ç»“æŸå¹¶å®Œæˆï¼\nğŸ“Š ${passedCount}ä¸ªæ–‡ä»¶é€šè¿‡æŠ•ç¥¨\nâ­ï¸ ä¼šè®®è¿›å…¥å…±åŒå®£è¨€é˜¶æ®µ\n\n2ç§’åè·³è½¬åˆ°å…±åŒå®£è¨€é¡µé¢...`);

                            // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                            if (autoRefreshInterval) {
                                clearInterval(autoRefreshInterval);
                            }

                            // 2ç§’åè·³è½¬åˆ°å…±åŒå®£è¨€é¡µé¢
                            setTimeout(() => {
                                const url = `/chairman-declaration?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}&force_completed=true`;
                                window.location.href = url;
                            }, 2000);

                        } else {
                            showError(data.message || 'å¼ºåˆ¶ç»“æŸå¤±è´¥');
                        }

                    } catch (error) {
                        console.error('å¼ºåˆ¶ç»“æŸæŠ•ç¥¨å¤±è´¥:', error);
                        showError('å¼ºåˆ¶ç»“æŸæ—¶å‘ç”Ÿé”™è¯¯');
                    }
                }
            } else {
                // æ‰€æœ‰æŠ•ç¥¨éƒ½å·²å®Œæˆï¼Œç›´æ¥è·³è½¬åˆ°å…±åŒå®£è¨€é˜¶æ®µ
                if (confirm('æ‰€æœ‰æŠ•ç¥¨éƒ½å·²å®Œæˆï¼Œç¡®å®šè¦å®ŒæˆæŠ•ç¥¨æµç¨‹å¹¶è¿›å…¥å…±åŒå®£è¨€é˜¶æ®µå—ï¼Ÿ')) {
                    try {
                        showSuccess('æ­£åœ¨å®ŒæˆæŠ•ç¥¨æµç¨‹...');

                        const response = await fetch('/api/finalize_file_voting', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                session_id: sessionId,
                                vote_matrix: voteMatrix,
                                completed_at: new Date().toISOString()
                            })
                        });

                        const data = await response.json();

                        if (data.code === 200) {
                            showSuccess('âœ… æŠ•ç¥¨æµç¨‹å®Œæˆï¼ä¼šè®®è¿›å…¥å…±åŒå®£è¨€é˜¶æ®µ\n\n2ç§’åè·³è½¬åˆ°å…±åŒå®£è¨€é¡µé¢...');

                            // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                            if (autoRefreshInterval) {
                                clearInterval(autoRefreshInterval);
                            }

                            // 2ç§’åè·³è½¬åˆ°å…±åŒå®£è¨€é¡µé¢
                            setTimeout(() => {
                                const url = `/chairman-declaration?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
                                window.location.href = url;
                            }, 2000);

                        } else {
                            showError(data.message || 'å®ŒæˆæŠ•ç¥¨å¤±è´¥');
                        }

                    } catch (error) {
                        console.error('å®ŒæˆæŠ•ç¥¨å¤±è´¥:', error);
                        showError('å®ŒæˆæŠ•ç¥¨æ—¶å‘ç”Ÿé”™è¯¯');
                    }
                }
            }
        }

        // å®ŒæˆæŠ•ç¥¨
        async function completeVoting() {
            const stats = calculateStats();
            
            if (stats.completedVotes < stats.totalVotes) {
                showError('è¯·ç­‰å¾…æ‰€æœ‰æŠ•ç¥¨å®Œæˆ');
                return;
            }
            
            if (confirm(`æŠ•ç¥¨ç»Ÿè®¡ï¼š\n\næ€»æŠ•ç¥¨æ•°ï¼š${stats.totalVotes}\nåŒæ„ï¼š${stats.agreeVotes}\nåå¯¹ï¼š${stats.disagreeVotes}\nå¼ƒæƒï¼š${stats.abstainVotes}\n\nâœ… ç¡®å®šè¦å®ŒæˆæŠ•ç¥¨å¹¶è¿›å…¥å…±åŒå®£è¨€é˜¶æ®µå—ï¼Ÿ\n\nç³»ç»Ÿå°†è‡ªåŠ¨ï¼š\nâ€¢ è®¡ç®—æœ€ç»ˆæŠ•ç¥¨ç»“æœ\nâ€¢ å¤„ç†é€šè¿‡çš„æ–‡ä»¶\nâ€¢ è·³è½¬åˆ°å®£è¨€ç®¡ç†é¡µé¢`)) {
                try {
                    const response = await fetch('/api/finalize_file_voting', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            vote_matrix: voteMatrix,
                            completed_at: new Date().toISOString()
                        })
                    });

                    const data = await response.json();
                    
                    if (data.code === 200) {
                        showSuccess('âœ… æŠ•ç¥¨æµç¨‹å®Œæˆï¼ä¼šè®®è¿›å…¥å…±åŒå®£è¨€é˜¶æ®µ\n\n2ç§’åè·³è½¬åˆ°å…±åŒå®£è¨€é¡µé¢...');
                        clearInterval(autoRefreshInterval);
                        
                        setTimeout(() => {
                            // è·³è½¬åˆ°ä¸»å¸­å…±åŒå®£è¨€ç®¡ç†é¡µé¢
                            const url = `/chairman-declaration?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
                            window.location.href = url;
                        }, 2000);
                    } else {
                        showError(data.message || 'å®ŒæˆæŠ•ç¥¨å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('å®ŒæˆæŠ•ç¥¨å¤±è´¥:', error);
                    showError('å®ŒæˆæŠ•ç¥¨æ—¶å‘ç”Ÿé”™è¯¯');
                }
            }
        }

        // å¯¼å‡ºæŠ•ç¥¨æŠ¥å‘Š
        function exportVoteReport() {
            const stats = calculateStats();
            
            let reportContent = `æŠ•ç¥¨ç›‘æ§æŠ¥å‘Š\n\n`;
            reportContent += `ä¼šè®®ç¼–å·ï¼š${sessionId}\n`;
            reportContent += `å§”å‘˜ä¼šï¼š${committeeName}\n`;
            reportContent += `è®®é¢˜ï¼š${agenda}\n`;
            reportContent += `ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;
            
            reportContent += `æŠ•ç¥¨ç»Ÿè®¡ï¼š\n`;
            reportContent += `- å‚ä¸å›½å®¶ï¼š${countries.length}ä¸ª\n`;
            reportContent += `- æŠ•ç¥¨æ–‡ä»¶ï¼š${files.length}ä¸ª\n`;
            reportContent += `- æ€»æŠ•ç¥¨æ•°ï¼š${stats.totalVotes}ä¸ª\n`;
            reportContent += `- å·²å®Œæˆï¼š${stats.completedVotes}ä¸ª (${Math.round((stats.completedVotes / stats.totalVotes) * 100)}%)\n`;
            reportContent += `- åŒæ„ç¥¨ï¼š${stats.agreeVotes}ä¸ª\n`;
            reportContent += `- åå¯¹ç¥¨ï¼š${stats.disagreeVotes}ä¸ª\n`;
            reportContent += `- å¼ƒæƒç¥¨ï¼š${stats.abstainVotes}ä¸ª\n\n`;
            
            reportContent += `æŠ•ç¥¨çŸ©é˜µè¯¦æƒ…ï¼š\n`;
            countries.forEach(country => {
                reportContent += `\n${country.name}ï¼š\n`;
                files.forEach(file => {
                    if (file.id !== country.id) {
                        const vote = voteMatrix[country.id] ? voteMatrix[country.id][file.id] : null;
                        const voteText = vote ? getVoteText(vote) : 'æœªæŠ•ç¥¨';
                        reportContent += `  - å¯¹${file.country_name}æ–‡ä»¶ï¼š${voteText}\n`;
                    }
                });
            });

            // ä¸‹è½½æŠ¥å‘Š
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æŠ•ç¥¨ç›‘æ§æŠ¥å‘Š_${sessionId}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showSuccess('æŠ•ç¥¨æŠ¥å‘Šå·²å¯¼å‡º');
        }

        // è¿”å›åŠ¨è®®ç®¡ç†
        function goBack() {
            const url = `/chairman-motion?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
            window.location.href = url;
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(async () => {
                await loadVoteDetails();
                renderVoteMatrix();
                updateAllStats();
            }, 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            alert.className = 'alert alert-success show';
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            alert.className = 'alert alert-error show';
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
