<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主席投票监控｜WTO 模拟谈判</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left h1 {
            text-align: center;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 8px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .vote-info {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .vote-info h3 {
            margin: 0 0 16px;
            color: #1e293b;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .info-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        .vote-mechanism {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vote-mechanism strong {
            color: #065f46;
        }

        .vote-status-bar {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        .refresh-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #6b7280;
        }

        .result-indicator {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-indicator.passed {
            background: #d1fae5;
            border-color: #a7f3d0;
        }

        .result-indicator.failed {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .result-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .result-detail {
            font-size: 14px;
            color: #6b7280;
        }

        /* 投票矩阵样式 */
        .vote-matrix-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .panel-title-text {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .vote-matrix-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .matrix-note {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0c4a6e;
        }

        .vote-matrix {
            display: table;
            width: 100%;
            border-collapse: separate;
            border-spacing: 2px;
            min-width: 800px;
        }

        .matrix-header,
        .matrix-row {
            display: table-row;
        }

        .matrix-cell {
            display: table-cell;
            padding: 12px 8px;
            text-align: center;
            vertical-align: middle;
            border-radius: 6px;
            font-size: 14px;
            min-width: 80px;
        }

        .matrix-cell.corner {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            color: #374151;
        }

        .matrix-cell.file-header {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            font-weight: 600;
            color: #1e40af;
        }

        .matrix-cell.country-header {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            font-weight: 600;
            color: #166534;
            min-width: 100px;
        }

        .matrix-cell.progress-header {
            background: #fef3c7;
            border: 1px solid #fde68a;
            font-weight: 600;
            color: #92400e;
        }

        .file-flag,
        .country-flag {
            width: 20px;
            height: 15px;
            border-radius: 2px;
            margin-right: 6px;
            vertical-align: middle;
        }

        .vote-cell {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .vote-cell:hover {
            transform: scale(1.05);
        }

        .vote-cell.voted.agree {
            background: #d1fae5;
            border-color: #a7f3d0;
            color: #065f46;
        }

        .vote-cell.voted.disagree {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .vote-cell.voted.abstain {
            background: #fef3c7;
            border-color: #fde68a;
            color: #92400e;
        }

        .vote-cell.pending {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #6b7280;
            animation: pending-pulse 2s infinite;
        }

        .vote-cell.self {
            background: #e5e7eb;
            border-color: #9ca3af;
            color: #6b7280;
            cursor: not-allowed;
        }

        @keyframes pending-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .progress-cell {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px;
        }

        .progress-text {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .mini-progress {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        .stats-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .controls {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .vote-matrix {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-left">
            <h1>WTO 模拟谈判 - 主席投票监控</h1>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <h1>🗳️ 主席投票监控</h1>
            <p>实时监控各国投票状态，管理投票流程</p>
        </div>

        <!-- 投票信息 -->
        <div class="vote-info">
            <h3>📋 投票信息</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">会议编号：</span>
                    <span class="info-value" id="session-display">{{ session_id or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">委员会：</span>
                    <span class="info-value" id="committee-display">{{ committee_name or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">议题：</span>
                    <span class="info-value" id="agenda-display">{{ agenda or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">投票开始：</span>
                    <span class="info-value" id="vote-start-time">-</span>
                </div>
            </div>
            <div class="vote-mechanism">
                <strong>投票机制：</strong>
                <span id="mechanism-name">{{ mechanism_name or '协商一致' }}</span>
                <span style="color: #6b7280; margin-left: 10px;" id="mechanism-requirement">({{ mechanism_requirement or '要求：100% 同意' }})</span>
            </div>
        </div>

        <!-- 投票进度状态 -->
        <div class="vote-status-bar">
            <div class="status-header">
                <div class="status-title">投票进度</div>
                <div class="auto-refresh">
                    <div class="refresh-dot"></div>
                    <span>每5秒自动刷新</span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">正在加载投票数据...</div>
        </div>

        <!-- 投票结果预览 -->
        <div class="result-indicator" id="result-indicator">
            <div class="result-text" id="result-text">投票准备中...</div>
            <div class="result-detail" id="result-detail">等待加载投票数据</div>
        </div>

        <!-- 提示信息 -->
        <div id="alert" class="alert"></div>

        <!-- 投票矩阵表格 -->
        <div class="vote-matrix-section">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="panel-icon">📊</div>
                    <div class="panel-title-text">投票完成情况矩阵</div>
                </div>
                <div class="panel-actions">
                    <button class="btn btn-secondary btn-small" onclick="refreshVoteData()">🔄 刷新数据</button>
                    
                    <button class="btn btn-primary btn-small" onclick="exportVoteReport()">📊 导出报告</button>
                </div>
            </div>
            
            <div class="vote-matrix-container">
                <div class="matrix-note">
                    <span>📝 说明：横向为投票国家，纵向为被投票文件，绿色表示同意，红色表示反对，橙色表示弃权，灰色表示未投票</span>
                </div>
                
                <div class="vote-matrix" id="vote-matrix">
                    <div class="matrix-header">
                        <div class="matrix-cell corner">投票国 \ 文件</div>
                        <div class="matrix-cell progress-header">完成度</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->


        <!-- 控制面板 -->
        <div class="controls">
            <div class="buttons">
                <button class="btn btn-primary" onclick="refreshVoteData()">
                    🔄 手动刷新
                </button>
                <button class="btn btn-danger" onclick="forceEndVoting()" style="background: linear-gradient(135deg, #dc2626, #b91c1c);">
                    🛑 强制结束投票
                </button>
                <button class="btn btn-success" onclick="completeVoting()" id="complete-btn" style="background: linear-gradient(135deg, #059669, #047857);">
                    ✅ 完成投票
                </button>
                <button class="btn btn-secondary" onclick="goBack()">
                    ← 返回动议管理
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let sessionId = "{{ session_id or '' }}";
        let committeeName = "{{ committee_name or '' }}";
        let agenda = "{{ agenda or '' }}";
        let mechanismName = "{{ mechanism_name or '协商一致' }}";
        let mechanismRequirement = "{{ mechanism_requirement or '要求：100% 同意' }}";
        
        let voteMatrix = {};
        let countries = [];
        let files = [];
        let autoRefreshInterval;

        // DOM 元素
        const alert = document.getElementById('alert');
        const voteMatrixEl = document.getElementById('vote-matrix');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const resultIndicator = document.getElementById('result-indicator');
        const resultText = document.getElementById('result-text');
        const resultDetail = document.getElementById('result-detail');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('主席投票监控页面已加载');
            console.log('会议信息:', { sessionId, committeeName, agenda });
            
            // 设置投票开始时间
            document.getElementById('vote-start-time').textContent = new Date().toLocaleString();
            
            loadVoteData();
            startAutoRefresh();
        });

        // 加载投票数据
        async function loadVoteData() {
            try {
                // 加载到场国家
                await loadArrivedCountries();
                
                // 加载提交的文件
                await loadSubmittedFiles();
                
                // 加载投票详情
                await loadVoteDetails();
                
                // 渲染投票矩阵
                renderVoteMatrix();
                updateAllStats();
                
            } catch (error) {
                console.error('加载投票数据失败:', error);
            }
        }

        // 加载到场国家
        async function loadArrivedCountries() {
            const response = await fetch(`/api/rollcall/arrived?session_id=${encodeURIComponent(sessionId)}`);
            const data = await response.json();
            
            if (data.code === 200) {
                const arrivedIds = data.data || [];
                
                // 获取国家详细信息
                const countriesResponse = await fetch(`/api/countries?session_id=${encodeURIComponent(sessionId)}`);
                const countriesData = await countriesResponse.json();
                
                if (countriesData.code === 200) {
                    const allCountriesData = countriesData.data || [];
                    countries = allCountriesData.filter(country => 
                        arrivedIds.includes(country.id)
                    );
                    console.log('到场国家数量:', countries.length);
                }
            }
        }

        // 加载提交的文件
        async function loadSubmittedFiles() {
            const response = await fetch(`/api/submissions?session_id=${encodeURIComponent(sessionId)}`);
            const data = await response.json();
            
            if (data.code === 200) {
                const submissions = data.data || [];
                
                // 获取文件对应的国家信息
                files = [];
                for (const submission of submissions) {
                    const country = countries.find(c => c.id === submission.country_id);
                    if (country) {
                        files.push({
                            id: submission.country_id,
                            country_name: country.name,
                            flag_url: country.flag_url,
                            filename: submission.file_name || '文本提交',
                            created_at: submission.created_at
                        });
                    }
                }
                console.log('提交文件数量:', files.length);
            }
        }

        // 加载投票详情
        async function loadVoteDetails() {
            try {
                // 使用与投票提交相同的数据库连接方式
                const response = await fetch(`/api/get_file_vote_details_by_session?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const voteDetails = data.data || [];
                    
                    // 构建投票矩阵
                    voteMatrix = {};
                    countries.forEach(country => {
                        voteMatrix[country.id] = {};
                        files.forEach(file => {
                            if (file.id !== country.id) { // 不能给自己的文件投票
                                voteMatrix[country.id][file.id] = null;
                            }
                        });
                    });
                    
                    // 填入已有的投票数据
                    voteDetails.forEach(vote => {
                        if (voteMatrix[vote.country_id] && voteMatrix[vote.country_id][vote.file_id] !== undefined) {
                            voteMatrix[vote.country_id][vote.file_id] = vote.vote_result;
                        }
                    });
                    
                    console.log('投票矩阵已构建');
                } else {
                    console.warn('获取投票详情失败:', data.message);
                }
            } catch (error) {
                console.error('加载投票详情失败:', error);
            }
        }

        // 渲染投票矩阵
        function renderVoteMatrix() {
            if (countries.length === 0 || files.length === 0) {
                voteMatrixEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <div>暂无投票数据</div>
                    </div>
                `;
                return;
            }

            // 构建表头
            let headerHTML = '<div class="matrix-cell corner">投票国 \\ 文件</div>';
            files.forEach(file => {
                headerHTML += `
                    <div class="matrix-cell file-header">
                        <img class="file-flag" src="${file.flag_url}" alt="${file.country_name}">
                        <span>${file.country_name}文件</span>
                    </div>
                `;
            });
            headerHTML += '<div class="matrix-cell progress-header">完成度</div>';

            // 构建数据行
            let rowsHTML = '';
            countries.forEach(country => {
                let rowHTML = `
                    <div class="matrix-row">
                        <div class="matrix-cell country-header">
                            <img class="country-flag" src="${country.flag_url}" alt="${country.name}">
                            <span>${country.name}</span>
                        </div>
                `;

                let completedVotes = 0;
                let totalVotes = 0;

                files.forEach(file => {
                    if (file.id === country.id) {
                        // 自己的文件
                        rowHTML += '<div class="matrix-cell vote-cell self">-</div>';
                    } else {
                        totalVotes++;
                        const vote = voteMatrix[country.id] ? voteMatrix[country.id][file.id] : null;
                        
                        if (vote) {
                            completedVotes++;
                            const voteClass = `voted ${vote}`;
                            const voteIcon = vote === 'agree' ? '✅' : vote === 'disagree' ? '❌' : '⚪';
                            const voteTitle = `${country.name}对${file.country_name}文件：${getVoteText(vote)}`;
                            
                            rowHTML += `<div class="matrix-cell vote-cell ${voteClass}" title="${voteTitle}">${voteIcon}</div>`;
                        } else {
                            rowHTML += `<div class="matrix-cell vote-cell pending" title="${country.name}对${file.country_name}文件：未投票">⏳</div>`;
                        }
                    }
                });

                // 进度列
                const progressPercentage = totalVotes > 0 ? Math.round((completedVotes / totalVotes) * 100) : 0;
                rowHTML += `
                    <div class="matrix-cell progress-cell">
                        <span class="progress-text">${completedVotes}/${totalVotes}</span>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                </div>
                `;

                rowsHTML += rowHTML;
            });

            voteMatrixEl.innerHTML = `
                <div class="matrix-header">${headerHTML}</div>
                ${rowsHTML}
            `;
        }

        // 获取投票文本
        function getVoteText(voteType) {
            const texts = {
                'agree': '同意',
                'disagree': '反对',
                'abstain': '弃权'
            };
            return texts[voteType] || '未知';
        }

        // 计算统计数据
        function calculateStats() {
            let stats = {
                totalVotes: 0,
                completedVotes: 0,
                agreeVotes: 0,
                disagreeVotes: 0,
                abstainVotes: 0,
                completedCountries: 0
            };

            Object.keys(voteMatrix).forEach(countryId => {
                let countryCompleted = 0;
                let countryTotal = 0;
                
                Object.keys(voteMatrix[countryId]).forEach(fileId => {
                    countryTotal++;
                    stats.totalVotes++;
                    
                    const vote = voteMatrix[countryId][fileId];
                    if (vote !== null) {
                        countryCompleted++;
                        stats.completedVotes++;
                        
                        if (vote === 'agree') stats.agreeVotes++;
                        else if (vote === 'disagree') stats.disagreeVotes++;
                        else if (vote === 'abstain') stats.abstainVotes++;
                    }
                });
                
                if (countryCompleted === countryTotal) {
                    stats.completedCountries++;
                }
            });

            return stats;
        }

        // 更新所有统计显示
        function updateAllStats() {
            const stats = calculateStats();
            
            // 更新进度条
            const percentage = stats.totalVotes > 0 ? Math.round((stats.completedVotes / stats.totalVotes) * 100) : 0;
            progressFill.style.width = percentage + '%';
            progressText.textContent = `已完成投票：${stats.completedVotes}/${stats.totalVotes} (${percentage}%)`;
            
            // 更新结果指示器
            if (stats.completedVotes === stats.totalVotes) {
                if (stats.disagreeVotes === 0) {
                    resultIndicator.className = 'result-indicator passed';
                    resultText.textContent = '🎉 所有文件投票完成！';
                    resultDetail.textContent = '可以进入下一阶段';
                } else {
                    resultIndicator.className = 'result-indicator';
                    resultText.textContent = '📊 投票完成';
                    resultDetail.textContent = `同意：${stats.agreeVotes}，反对：${stats.disagreeVotes}，弃权：${stats.abstainVotes}`;
                }
            } else {
                resultIndicator.className = 'result-indicator';
                resultText.textContent = '投票进行中...';
            }
            
            // 更新统计卡片
            document.getElementById('total-countries').textContent = countries.length;
            document.getElementById('completed-votes').textContent = stats.completedVotes;
            document.getElementById('agree-votes').textContent = stats.agreeVotes;
            document.getElementById('disagree-votes').textContent = stats.disagreeVotes;
            document.getElementById('abstain-votes').textContent = stats.abstainVotes;
            document.getElementById('vote-progress').textContent = percentage + '%';
            
            // 更新完成按钮状态
            const completeBtn = document.getElementById('complete-btn');
            if (stats.completedVotes === stats.totalVotes) {
                completeBtn.disabled = false;
                completeBtn.textContent = '✅ 完成投票';
            } else {
                completeBtn.disabled = true;
                completeBtn.textContent = `✅ 完成投票 (${stats.totalVotes - stats.completedVotes}个待投票)`;
            }
        }

        // 刷新投票数据
        async function refreshVoteData() {
            showSuccess('正在刷新投票数据...');
            await loadVoteData();
            showSuccess('投票数据已刷新');
        }

        // 初始化测试数据
        async function initTestData() {
            try {
                if (confirm('确定要初始化测试数据吗？这将创建示例国家和文件数据。')) {
                    showSuccess('正在初始化测试数据...');
                    
                    const response = await fetch('/api/init_vote_data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        showSuccess('测试数据初始化成功，正在重新加载...');
                        setTimeout(async () => {
                            await loadVoteData();
                            showSuccess('数据加载完成！');
                        }, 1000);
                    } else {
                        showError(data.message || '初始化失败');
                    }
                }
            } catch (error) {
                console.error('初始化测试数据失败:', error);
                showError('初始化时发生错误');
            }
        }

        // 发送投票提醒
        async function sendVoteReminder() {
            try {
                const stats = calculateStats();
                const pendingVotes = stats.totalVotes - stats.completedVotes;
                
                if (pendingVotes === 0) {
                    showError('所有投票都已完成，无需发送提醒');
                    return;
                }

                const response = await fetch('/api/send_vote_reminder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                
                if (data.code === 200) {
                    showSuccess(`已向未完成投票的国家发送提醒 (${pendingVotes}个待投票)`);
                } else {
                    showError(data.message || '发送提醒失败');
                }
                
            } catch (error) {
                console.error('发送投票提醒失败:', error);
                showError('发送提醒时发生错误');
            }
        }

        // 延长投票时间
        async function extendVoteDeadline() {
            const newDeadline = prompt('请输入新的投票截止时间 (格式：YYYY-MM-DD HH:MM)');
            if (newDeadline) {
                try {
                    const response = await fetch('/api/extend_vote_deadline', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            new_deadline: newDeadline
                        })
                    });

                    const data = await response.json();
                    
                    if (data.code === 200) {
                        showSuccess('投票截止时间已延长');
                    } else {
                        showError(data.message || '延长时间失败');
                    }
                    
                } catch (error) {
                    console.error('延长投票时间失败:', error);
                    showError('延长时间时发生错误');
                }
            }
        }

        // 强制结束投票并直接进入共同宣言阶段
        async function forceEndVoting() {
            const stats = calculateStats();
            const pendingVotes = stats.totalVotes - stats.completedVotes;

            if (pendingVotes > 0) {
                if (confirm(`还有${pendingVotes}个投票未完成，确定要强制结束投票吗？\n\n⚠️ 注意：强制结束后将自动：\n• 标记未投票为弃权\n• 计算投票结果\n• 处理通过的文件\n• 直接进入共同宣言阶段\n\n确定继续吗？`)) {
                    try {
                        showSuccess('正在强制结束投票并完成流程...');

                        const response = await fetch('/api/force_end_voting', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                session_id: sessionId
                            })
                        });

                        const data = await response.json();

                        if (data.code === 200) {
                            const passedCount = data.data.passed_files_count;
                            const uncompletedCount = data.data.uncompleted_count;

                            showSuccess(`✅ 投票强制结束并完成！\n📊 ${passedCount}个文件通过投票\n⏭️ 会议进入共同宣言阶段\n\n2秒后跳转到共同宣言页面...`);

                            // 停止自动刷新
                            if (autoRefreshInterval) {
                                clearInterval(autoRefreshInterval);
                            }

                            // 2秒后跳转到共同宣言页面
                            setTimeout(() => {
                                const url = `/chairman-declaration?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}&force_completed=true`;
                                window.location.href = url;
                            }, 2000);

                        } else {
                            showError(data.message || '强制结束失败');
                        }

                    } catch (error) {
                        console.error('强制结束投票失败:', error);
                        showError('强制结束时发生错误');
                    }
                }
            } else {
                // 所有投票都已完成，直接跳转到共同宣言阶段
                if (confirm('所有投票都已完成，确定要完成投票流程并进入共同宣言阶段吗？')) {
                    try {
                        showSuccess('正在完成投票流程...');

                        const response = await fetch('/api/finalize_file_voting', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                session_id: sessionId,
                                vote_matrix: voteMatrix,
                                completed_at: new Date().toISOString()
                            })
                        });

                        const data = await response.json();

                        if (data.code === 200) {
                            showSuccess('✅ 投票流程完成！会议进入共同宣言阶段\n\n2秒后跳转到共同宣言页面...');

                            // 停止自动刷新
                            if (autoRefreshInterval) {
                                clearInterval(autoRefreshInterval);
                            }

                            // 2秒后跳转到共同宣言页面
                            setTimeout(() => {
                                const url = `/chairman-declaration?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
                                window.location.href = url;
                            }, 2000);

                        } else {
                            showError(data.message || '完成投票失败');
                        }

                    } catch (error) {
                        console.error('完成投票失败:', error);
                        showError('完成投票时发生错误');
                    }
                }
            }
        }

        // 完成投票
        async function completeVoting() {
            const stats = calculateStats();
            
            if (stats.completedVotes < stats.totalVotes) {
                showError('请等待所有投票完成');
                return;
            }
            
            if (confirm(`投票统计：\n\n总投票数：${stats.totalVotes}\n同意：${stats.agreeVotes}\n反对：${stats.disagreeVotes}\n弃权：${stats.abstainVotes}\n\n✅ 确定要完成投票并进入共同宣言阶段吗？\n\n系统将自动：\n• 计算最终投票结果\n• 处理通过的文件\n• 跳转到宣言管理页面`)) {
                try {
                    const response = await fetch('/api/finalize_file_voting', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            vote_matrix: voteMatrix,
                            completed_at: new Date().toISOString()
                        })
                    });

                    const data = await response.json();
                    
                    if (data.code === 200) {
                        showSuccess('✅ 投票流程完成！会议进入共同宣言阶段\n\n2秒后跳转到共同宣言页面...');
                        clearInterval(autoRefreshInterval);
                        
                        setTimeout(() => {
                            // 跳转到主席共同宣言管理页面
                            const url = `/chairman-declaration?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
                            window.location.href = url;
                        }, 2000);
                    } else {
                        showError(data.message || '完成投票失败');
                    }
                    
                } catch (error) {
                    console.error('完成投票失败:', error);
                    showError('完成投票时发生错误');
                }
            }
        }

        // 导出投票报告
        function exportVoteReport() {
            const stats = calculateStats();
            
            let reportContent = `投票监控报告\n\n`;
            reportContent += `会议编号：${sessionId}\n`;
            reportContent += `委员会：${committeeName}\n`;
            reportContent += `议题：${agenda}\n`;
            reportContent += `生成时间：${new Date().toLocaleString()}\n\n`;
            
            reportContent += `投票统计：\n`;
            reportContent += `- 参与国家：${countries.length}个\n`;
            reportContent += `- 投票文件：${files.length}个\n`;
            reportContent += `- 总投票数：${stats.totalVotes}个\n`;
            reportContent += `- 已完成：${stats.completedVotes}个 (${Math.round((stats.completedVotes / stats.totalVotes) * 100)}%)\n`;
            reportContent += `- 同意票：${stats.agreeVotes}个\n`;
            reportContent += `- 反对票：${stats.disagreeVotes}个\n`;
            reportContent += `- 弃权票：${stats.abstainVotes}个\n\n`;
            
            reportContent += `投票矩阵详情：\n`;
            countries.forEach(country => {
                reportContent += `\n${country.name}：\n`;
                files.forEach(file => {
                    if (file.id !== country.id) {
                        const vote = voteMatrix[country.id] ? voteMatrix[country.id][file.id] : null;
                        const voteText = vote ? getVoteText(vote) : '未投票';
                        reportContent += `  - 对${file.country_name}文件：${voteText}\n`;
                    }
                });
            });

            // 下载报告
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `投票监控报告_${sessionId}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showSuccess('投票报告已导出');
        }

        // 返回动议管理
        function goBack() {
            const url = `/chairman-motion?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
            window.location.href = url;
        }

        // 开始自动刷新
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(async () => {
                await loadVoteDetails();
                renderVoteMatrix();
                updateAllStats();
            }, 5000);
        }

        // 显示成功消息
        function showSuccess(message) {
            alert.className = 'alert alert-success show';
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // 显示错误消息
        function showError(message) {
            alert.className = 'alert alert-error show';
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
