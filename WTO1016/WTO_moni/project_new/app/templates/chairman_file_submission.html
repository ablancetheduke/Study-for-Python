<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主席文件提交监控｜WTO 模拟谈判</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left h1 {
            text-align: center;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 8px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .session-info {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .session-info h3 {
            margin: 0 0 16px;
            color: #1e293b;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .info-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        .deadline-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .deadline-info.warning {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .panel-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .panel-title-text {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .panel-actions {
            display: flex;
            gap: 8px;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .countries-list {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .country-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .country-item:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .country-item.submitted {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .country-item.pending {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .country-item.overdue {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .country-flag {
            width: 40px;
            height: 30px;
            border-radius: 4px;
            object-fit: cover;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .country-info {
            flex: 1;
        }
        
        .country-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .country-status {
            font-size: 12px;
            color: #6b7280;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .status-badge.submitted {
            background: #10b981;
            color: white;
        }
        
        .status-badge.pending {
            background: #f59e0b;
            color: white;
        }
        
        .status-badge.overdue {
            background: #ef4444;
            color: white;
        }

        .file-actions {
            display: flex;
            gap: 6px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .controls {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* 文件预览模态框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .close {
            color: #6b7280;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #374151;
        }
        
        .file-preview {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            background: #f8fafc;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .country-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .file-info {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-left">
            <h1>WTO 模拟谈判 - 文件提交监控</h1>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <h1>📁 文件提交监控</h1>
            <p>监控到场国家文件提交情况，确保会议材料完整</p>
        </div>

        <!-- 会议信息 -->
        <div class="session-info">
            <h3>📋 会议信息</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">会议编号：</span>
                    <span class="info-value" id="session-display">{{ session_id or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">委员会：</span>
                    <span class="info-value" id="committee-display">{{ committee_name or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">议题：</span>
                    <span class="info-value" id="agenda-display">{{ agenda or '未设置' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">投票机制：</span>
                    <span class="info-value" id="mechanism-display">{{ mechanism_name or '未设置' }}</span>
                </div>
            </div>
        </div>

        <!-- 提示信息 -->
        <div id="alert" class="alert"></div>

        <!-- 主要内容 -->
        <div class="main-content">
            <!-- 参会国列表 -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">🌍</div>
                        <div class="panel-title-text">到场国家列表</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshData()">🔄 刷新</button>
                        <button class="btn btn-primary btn-small" onclick="exportReport()">📊 导出报告</button>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="搜索到场国家名称...">
                </div>
                
                <div class="countries-list" id="countries-list">
                    <div class="loading">正在加载到场国家信息...</div>
                </div>
            </div>
            
            <!-- 文件提交状态 -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">📋</div>
                        <div class="panel-title-text">文件提交状态</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary btn-small" onclick="filterByStatus('all')">全部</button>
                        <button class="btn btn-warning btn-small" onclick="filterByStatus('pending')">待提交</button>
                        <button class="btn btn-success btn-small" onclick="filterByStatus('submitted')">已提交</button>
                    </div>
                </div>
                
                <div class="countries-list" id="submission-status">
                    <div class="loading">正在加载提交状态...</div>
                </div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="controls">

            
            <div class="buttons">

                <button class="btn btn-success" id="proceed-btn" onclick="proceedToNext()" >
                    ✅ 进入动议阶段
                </button>
                <button class="btn btn-primary" id="skip-to-vote-btn" onclick="skipToVoting()">
                    🗳️ 跳过动议直接投票
                </button>
                <button class="btn btn-secondary" onclick="goBack()">
                    ← 返回点名
                </button>
            </div>
        </div>
    </div>

    <!-- 文件预览模态框 -->
    <div id="file-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">文件预览</div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="file-preview" id="file-preview">
                <!-- 文件内容将在这里显示 -->
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let sessionId = "{{ session_id or '' }}";
        let committeeName = "{{ committee_name or '' }}";
        let agenda = "{{ agenda or '' }}";
        let mechanismName = "{{ mechanism_name or '' }}";
        let mechanismRequirement = "{{ mechanism_requirement or '' }}";
        
        let allCountries = [];
        let submissionData = {};
        let arrivedCountries = [];
        let searchTerm = '';
        let currentFilter = 'all';
        
        // DOM 元素
        const countriesList = document.getElementById('countries-list');
        const submissionStatus = document.getElementById('submission-status');
        const searchInput = document.getElementById('search-input');
        const alert = document.getElementById('alert');
        const deadlineInfo = document.getElementById('deadline-info');
        const timeRemaining = document.getElementById('time-remaining');
        
        // 统计元素
        const totalCountriesEl = document.getElementById('total-countries');
        const submittedCountEl = document.getElementById('submitted-count');
        const pendingCountEl = document.getElementById('pending-count');
        const submissionRateEl = document.getElementById('submission-rate');
        
        // 模态框元素
        const fileModal = document.getElementById('file-modal');
        const modalTitle = document.getElementById('modal-title');
        const filePreview = document.getElementById('file-preview');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('主席文件提交监控页面已加载');
            console.log('会议信息:', { sessionId, committeeName, agenda, mechanismName });
            
            loadArrivedCountries();
            loadSubmissions();
            startCountdown();
            setupEventListeners();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 搜索功能
            searchInput.addEventListener('input', function(e) {
                searchTerm = e.target.value.toLowerCase();
                renderCountries();
            });
        }
        
        // 加载到场国家列表
        async function loadArrivedCountries() {
            try {
                const response = await fetch(`/api/rollcall/arrived?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const arrivedIds = data.data || [];
                    
                    // 获取国家详细信息
                    const countriesResponse = await fetch(`/api/countries?session_id=${encodeURIComponent(sessionId)}`);
                    const countriesData = await countriesResponse.json();
                    
                    if (countriesData.code === 200) {
                        const allCountriesData = countriesData.data || [];
                        
                        // 筛选出到场的国家
                        arrivedCountries = allCountriesData.filter(country => 
                            arrivedIds.includes(country.id)
                        );
                        
                        console.log('到场国家数量:', arrivedCountries.length);
                        renderCountries();
                        updateStats();
                    }
                } else {
                    showError('加载到场国家失败：' + (data.message || '未知错误'));
                }
            } catch (error) {
                console.error('加载到场国家失败:', error);
            }
        }
        
        // 加载文件提交情况
        async function loadSubmissions() {
            try {
                const response = await fetch(`/api/submissions?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const submissions = data.data || [];
                    
                    // 处理提交数据
                    submissionData = {};
                    submissions.forEach(submission => {
                        submissionData[submission.country_id] = {
                            status: 'submitted',
                            filename: submission.file_name || '文本提交',
                            submitTime: formatDateTime(submission.created_at),
                            size: submission.file_name ? '未知大小' : '文本内容',
                            text: submission.text
                        };
                    });
                    
                    console.log('文件提交数量:', submissions.length);
                    renderSubmissionStatus();
                    updateStats();
                } else {
                    showError('加载提交状态失败：' + (data.message || '未知错误'));
                }
            } catch (error) {
                console.error('加载提交状态失败:', error);
            }
        }
        
        // 渲染国家列表
        function renderCountries() {
            if (arrivedCountries.length === 0) {
                countriesList.innerHTML = '<div class="empty-state"><div class="empty-icon">🌍</div><div>暂无到场国家</div></div>';
                return;
            }
            
            const filteredCountries = arrivedCountries.filter(country => 
                country.name.toLowerCase().includes(searchTerm)
            );
            
            countriesList.innerHTML = filteredCountries.map(country => {
                const submission = submissionData[country.id];
                const status = submission ? submission.status : 'pending';
                const statusClass = status === 'submitted' ? 'submitted' : 'pending';
                const statusBadge = getStatusBadge(status);
                
                return `
                    <div class="country-item ${statusClass}">
                        <img class="country-flag" src="${country.flag_url}" alt="${country.name}" onerror="this.src='/static/flags/default.png'">
                        <div class="country-info">
                            <div class="country-name">${country.name}</div>
                            <div class="country-status">
                                ${submission && submission.filename ? 
                                    `文件：${submission.filename} (${submission.size})` : 
                                    '尚未提交文件'
                                }
                            </div>
                        </div>
                        <div class="file-info">
                            <span class="status-badge ${status}">${statusBadge}</span>
                            <div class="file-actions">
                                ${submission && submission.filename ? 
                                    `<button class="btn btn-success btn-small" onclick="viewFile('${country.id}')">👁️ 查看</button>` :
                                    ``
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 渲染提交状态
        function renderSubmissionStatus() {
            const filteredCountries = arrivedCountries.filter(country => {
                if (currentFilter === 'all') return true;
                const submission = submissionData[country.id];
                const status = submission ? submission.status : 'pending';
                return status === currentFilter;
            });
            
            if (filteredCountries.length === 0) {
                submissionStatus.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <div>没有找到符合条件的国家</div>
                    </div>
                `;
                return;
            }
            
            submissionStatus.innerHTML = filteredCountries.map(country => {
                const submission = submissionData[country.id];
                const status = submission ? submission.status : 'pending';
                const statusClass = status === 'submitted' ? 'submitted' : 'pending';
                const statusBadge = getStatusBadge(status);
                
                return `
                    <div class="country-item ${statusClass}">
                        <img class="country-flag" src="${country.flag_url}" alt="${country.name}" onerror="this.src='/static/flags/default.png'">
                        <div class="country-info">
                            <div class="country-name">${country.name}</div>
                            <div class="country-status">
                                ${submission && submission.submitTime ? 
                                    `提交时间：${submission.submitTime}` : 
                                    '等待提交'
                                }
                            </div>
                        </div>
                        <div class="file-info">
                            <span class="status-badge ${status}">${statusBadge}</span>
                            <div class="file-actions">
                                ${submission && submission.filename ? 
                                    `<button class="btn btn-success btn-small" onclick="viewFile('${country.id}')">👁️ 查看</button>` :
                                    ``
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 获取状态徽章
        function getStatusBadge(status) {
            switch (status) {
                case 'submitted': return '✅ 已提交';
                case 'pending': return '⏳ 待提交';
                default: return '❓ 未知';
            }
        }
        
        // 按状态筛选
        function filterByStatus(status) {
            currentFilter = status;
            renderSubmissionStatus();
            
            // 更新按钮状态
            document.querySelectorAll('.panel-actions .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            const filterTexts = { 'all': '全部', 'pending': '待提交', 'submitted': '已提交' };
            const activeBtn = Array.from(document.querySelectorAll('.panel-actions .btn')).find(btn => 
                btn.textContent.includes(filterTexts[status])
            );
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }
        }
        
        // 查看文件
        function viewFile(countryId) {
            const country = arrivedCountries.find(c => c.id === countryId);
            const submission = submissionData[countryId];
            
            if (!submission) {
                showError('文件不存在');
                return;
            }
            
            modalTitle.textContent = `${country.name} - ${submission.filename}`;
            
            if (submission.filename === '文本提交') {
                // 显示文本内容
                filePreview.innerHTML = `
                    <div style="padding: 20px;">
                        <h4>文本内容：</h4>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 12px; line-height: 1.6; white-space: pre-wrap;">${submission.text}</div>
                        <p style="color: #6b7280; margin: 16px 0;">提交时间：${submission.submitTime}</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
                        </div>
                    </div>
                `;
            } else {
                // 显示文件信息
                filePreview.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📄</div>
                        <h3>${submission.filename}</h3>
                        <p style="color: #6b7280; margin: 10px 0;">文件大小：${submission.size}</p>
                        <p style="color: #6b7280; margin: 10px 0;">提交时间：${submission.submitTime}</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="downloadFile('${countryId}')">📥 下载文件</button>
                            <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
                        </div>
                    </div>
                `;
            }
            
            fileModal.style.display = 'block';
        }
        
        // 下载文件
        function downloadFile(countryId) {
            const submission = submissionData[countryId];
            if (submission && submission.filename && submission.filename !== '文本提交') {
                const downloadUrl = `/static/uploads/${submission.filename}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = submission.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess(`开始下载 ${submission.filename}`);
            } else {
                showError('无法下载该文件');
            }
        }
        
        // 关闭模态框
        function closeModal() {
            fileModal.style.display = 'none';
        }
        

        // 发送提醒
        async function sendReminder() {
            try {
                const pendingCountries = arrivedCountries.filter(country => {
                    const submission = submissionData[country.id];
                    return !submission || submission.status === 'pending';
                });
                
                if (pendingCountries.length === 0) {
                    showError('所有国家都已提交文件');
                    return;
                }
                
                const countryIds = pendingCountries.map(c => c.id);
                
                const response = await fetch('/api/send_submission_reminder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        country_ids: countryIds
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    showSuccess(data.message);
                } else {
                    showError(data.message || '发送提醒失败');
                }
                
            } catch (error) {
                console.error('发送提醒失败:', error);
                showError('发送提醒时发生错误');
            }
        }
        
        // 发送个别提醒
        async function sendIndividualReminder(countryId) {
            try {
                const country = arrivedCountries.find(c => c.id === countryId);
                
                const response = await fetch('/api/send_submission_reminder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        country_ids: [countryId]
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    showSuccess(`已向 ${country.name} 发送提交提醒`);
                } else {
                    showError(data.message || '发送提醒失败');
                }
                
            } catch (error) {
                console.error('发送个别提醒失败:', error);
                showError('发送提醒时发生错误');
            }
        }
        
        // 延长截止时间
        async function extendDeadline() {
            const newDeadline = prompt('请输入新的截止时间 (格式：YYYY-MM-DD HH:MM)');
            if (newDeadline) {
                try {
                    const response = await fetch('/api/extend_submission_deadline', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            new_deadline: newDeadline
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        document.getElementById('deadline-time').textContent = newDeadline;
                        showSuccess(data.message);
                    } else {
                        showError(data.message || '更新截止时间失败');
                    }
                    
                } catch (error) {
                    console.error('延长截止时间失败:', error);
                    showError('延长截止时间时发生错误');
                }
            }
        }
        
        // 进入下一阶段
        function proceedToNext() {
            const submittedCount = Object.values(submissionData).filter(s => s.status === 'submitted').length;
            const totalCount = arrivedCountries.length;
            
            if (submittedCount < totalCount) {
                if (confirm(`还有 ${totalCount - submittedCount} 个国家未提交文件，确定要进入下一阶段吗？`)) {
                    proceedToMotion();
                }
            } else {
                proceedToMotion();
            }
        }
        
        // 跳转到动议阶段
        function proceedToMotion() {
            showSuccess('正在进入动议管理阶段...');
            setTimeout(() => {
                const url = `/chairman-motion?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
                window.location.href = url;
            }, 1000);
        }
        
        // 跳过动议直接投票
        function skipToVoting() {
            if (confirm('确定要跳过动议阶段，直接进入投票吗？')) {
                showSuccess('正在进入投票监控阶段...');
                setTimeout(() => {
                    const url = `/chairman-vote-monitoring?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}&mechanism_name=${encodeURIComponent(mechanismName)}&mechanism_requirement=${encodeURIComponent(mechanismRequirement)}`;
                    window.location.href = url;
                }, 1000);
            }
        }
        
        // 跳过动议直接投票
        function skipToVoting() {
            if (confirm('确定要跳过动议阶段，直接进入投票吗？')) {
                showSuccess('正在进入投票监控阶段...');
                setTimeout(() => {
                    const url = `/chairman-vote-monitoring?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}&mechanism_name=${encodeURIComponent(mechanismName)}&mechanism_requirement=${encodeURIComponent(mechanismRequirement)}`;
                    window.location.href = url;
                }, 1000);
            }
        }
        
        // 返回点名页面
        function goBack() {
            const url = `/chairman-rollcall?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}&mechanism_name=${encodeURIComponent(mechanismName)}&mechanism_requirement=${encodeURIComponent(mechanismRequirement)}`;
            window.location.href = url;
        }
        
        // 刷新数据
        async function refreshData() {
            showSuccess('正在刷新数据...');
            await loadArrivedCountries();
            await loadSubmissions();
            showSuccess('数据已刷新');
        }
        
        // 导出报告
        function exportReport() {
            const submittedCount = Object.values(submissionData).filter(s => s.status === 'submitted').length;
            const totalCount = arrivedCountries.length;
            const rate = totalCount > 0 ? Math.round((submittedCount / totalCount) * 100) : 0;
            
            const reportData = {
                sessionId,
                committeeName,
                agenda,
                totalCountries: totalCount,
                submittedCount,
                submissionRate: rate,
                timestamp: new Date().toLocaleString()
            };
            
            const reportText = `文件提交监控报告
            
会议编号：${sessionId}
委员会：${committeeName}
议题：${agenda}
生成时间：${reportData.timestamp}

统计信息：
- 到场国家数：${totalCount}
- 已提交文件：${submittedCount}
- 提交率：${rate}%

详细情况：
${arrivedCountries.map(country => {
    const submission = submissionData[country.id];
    const status = submission ? '已提交' : '待提交';
    const time = submission ? submission.submitTime : '未提交';
    return `- ${country.name}：${status} (${time})`;
}).join('\n')}`;
            
            // 下载报告
            const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `文件提交监控报告_${sessionId}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showSuccess('报告已导出');
        }
        
        // 更新统计信息
        function updateStats() {
            const total = arrivedCountries.length;
            const submitted = Object.values(submissionData).filter(s => s.status === 'submitted').length;
            const pending = total - submitted;
            const rate = total > 0 ? Math.round((submitted / total) * 100) : 0;
            
            totalCountriesEl.textContent = total;
            submittedCountEl.textContent = submitted;
            pendingCountEl.textContent = pending;
            submissionRateEl.textContent = rate + '%';
            
            // 更新进入下一阶段按钮状态
            const proceedBtn = document.getElementById('proceed-btn');
            if (submitted > 0) {
                proceedBtn.disabled = false;
                proceedBtn.textContent = '✅ 进入下一阶段';
            } else {
                proceedBtn.disabled = true;
                proceedBtn.textContent = '✅ 进入下一阶段 (需要至少1个提交)';
            }
        }
        
        // 倒计时功能
        function startCountdown() {
            const deadline = new Date('2024-12-31 23:59:00').getTime();
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = deadline - now;
                
                if (distance < 0) {
                    timeRemaining.textContent = '已过期';
                    deadlineInfo.classList.add('warning');
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                
                timeRemaining.textContent = `剩余 ${days}天 ${hours}小时 ${minutes}分钟`;
                
                if (days === 0 && hours < 24) {
                    deadlineInfo.classList.add('warning');
                }
            }
            
            updateCountdown();
            setInterval(updateCountdown, 60000); // 每分钟更新一次
        }
        
        // 格式化日期时间
        function formatDateTime(isoString) {
            if (!isoString) return '未知时间';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 显示成功消息
        function showSuccess(message) {
            alert.className = 'alert alert-success show';
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
        
        // 显示错误消息
        function showError(message) {
            alert.className = 'alert alert-error show';
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            if (event.target === fileModal) {
                closeModal();
            }
        }
    </script>
</body>
</html>