<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»å¸­æ–‡ä»¶æäº¤ç›‘æ§ï½œWTO æ¨¡æ‹Ÿè°ˆåˆ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left h1 {
            text-align: center;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 8px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .session-info {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .session-info h3 {
            margin: 0 0 16px;
            color: #1e293b;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .info-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        .deadline-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .deadline-info.warning {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .panel-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .panel-title-text {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .panel-actions {
            display: flex;
            gap: 8px;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .countries-list {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .country-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .country-item:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .country-item.submitted {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .country-item.pending {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .country-item.overdue {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .country-flag {
            width: 40px;
            height: 30px;
            border-radius: 4px;
            object-fit: cover;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .country-info {
            flex: 1;
        }
        
        .country-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .country-status {
            font-size: 12px;
            color: #6b7280;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .status-badge.submitted {
            background: #10b981;
            color: white;
        }
        
        .status-badge.pending {
            background: #f59e0b;
            color: white;
        }
        
        .status-badge.overdue {
            background: #ef4444;
            color: white;
        }

        .file-actions {
            display: flex;
            gap: 6px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .controls {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .close {
            color: #6b7280;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #374151;
        }
        
        .file-preview {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            background: #f8fafc;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .country-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .file-info {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-left">
            <h1>WTO æ¨¡æ‹Ÿè°ˆåˆ¤ - æ–‡ä»¶æäº¤ç›‘æ§</h1>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ–‡ä»¶æäº¤ç›‘æ§</h1>
            <p>ç›‘æ§åˆ°åœºå›½å®¶æ–‡ä»¶æäº¤æƒ…å†µï¼Œç¡®ä¿ä¼šè®®ææ–™å®Œæ•´</p>
        </div>

        <!-- ä¼šè®®ä¿¡æ¯ -->
        <div class="session-info">
            <h3>ğŸ“‹ ä¼šè®®ä¿¡æ¯</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">ä¼šè®®ç¼–å·ï¼š</span>
                    <span class="info-value" id="session-display">{{ session_id or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å§”å‘˜ä¼šï¼š</span>
                    <span class="info-value" id="committee-display">{{ committee_name or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">è®®é¢˜ï¼š</span>
                    <span class="info-value" id="agenda-display">{{ agenda or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æŠ•ç¥¨æœºåˆ¶ï¼š</span>
                    <span class="info-value" id="mechanism-display">{{ mechanism_name or 'æœªè®¾ç½®' }}</span>
                </div>
            </div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div id="alert" class="alert"></div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- å‚ä¼šå›½åˆ—è¡¨ -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">ğŸŒ</div>
                        <div class="panel-title-text">åˆ°åœºå›½å®¶åˆ—è¡¨</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary btn-small" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
                        <button class="btn btn-primary btn-small" onclick="exportReport()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="æœç´¢åˆ°åœºå›½å®¶åç§°...">
                </div>
                
                <div class="countries-list" id="countries-list">
                    <div class="loading">æ­£åœ¨åŠ è½½åˆ°åœºå›½å®¶ä¿¡æ¯...</div>
                </div>
            </div>
            
            <!-- æ–‡ä»¶æäº¤çŠ¶æ€ -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-icon">ğŸ“‹</div>
                        <div class="panel-title-text">æ–‡ä»¶æäº¤çŠ¶æ€</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary btn-small" onclick="filterByStatus('all')">å…¨éƒ¨</button>
                        <button class="btn btn-warning btn-small" onclick="filterByStatus('pending')">å¾…æäº¤</button>
                        <button class="btn btn-success btn-small" onclick="filterByStatus('submitted')">å·²æäº¤</button>
                    </div>
                </div>
                
                <div class="countries-list" id="submission-status">
                    <div class="loading">æ­£åœ¨åŠ è½½æäº¤çŠ¶æ€...</div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">

            
            <div class="buttons">

                <button class="btn btn-success" id="proceed-btn" onclick="proceedToNext()" >
                    âœ… è¿›å…¥åŠ¨è®®é˜¶æ®µ
                </button>
                <button class="btn btn-primary" id="skip-to-vote-btn" onclick="skipToVoting()">
                    ğŸ—³ï¸ è·³è¿‡åŠ¨è®®ç›´æ¥æŠ•ç¥¨
                </button>
                <button class="btn btn-secondary" onclick="goBack()">
                    â† è¿”å›ç‚¹å
                </button>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="file-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">æ–‡ä»¶é¢„è§ˆ</div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="file-preview" id="file-preview">
                <!-- æ–‡ä»¶å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let sessionId = "{{ session_id or '' }}";
        let committeeName = "{{ committee_name or '' }}";
        let agenda = "{{ agenda or '' }}";
        let mechanismName = "{{ mechanism_name or '' }}";
        let mechanismRequirement = "{{ mechanism_requirement or '' }}";
        
        let allCountries = [];
        let submissionData = {};
        let arrivedCountries = [];
        let searchTerm = '';
        let currentFilter = 'all';
        
        // DOM å…ƒç´ 
        const countriesList = document.getElementById('countries-list');
        const submissionStatus = document.getElementById('submission-status');
        const searchInput = document.getElementById('search-input');
        const alert = document.getElementById('alert');
        const deadlineInfo = document.getElementById('deadline-info');
        const timeRemaining = document.getElementById('time-remaining');
        
        // ç»Ÿè®¡å…ƒç´ 
        const totalCountriesEl = document.getElementById('total-countries');
        const submittedCountEl = document.getElementById('submitted-count');
        const pendingCountEl = document.getElementById('pending-count');
        const submissionRateEl = document.getElementById('submission-rate');
        
        // æ¨¡æ€æ¡†å…ƒç´ 
        const fileModal = document.getElementById('file-modal');
        const modalTitle = document.getElementById('modal-title');
        const filePreview = document.getElementById('file-preview');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¸»å¸­æ–‡ä»¶æäº¤ç›‘æ§é¡µé¢å·²åŠ è½½');
            console.log('ä¼šè®®ä¿¡æ¯:', { sessionId, committeeName, agenda, mechanismName });
            
            loadArrivedCountries();
            loadSubmissions();
            startCountdown();
            setupEventListeners();
        });
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æœç´¢åŠŸèƒ½
            searchInput.addEventListener('input', function(e) {
                searchTerm = e.target.value.toLowerCase();
                renderCountries();
            });
        }
        
        // åŠ è½½åˆ°åœºå›½å®¶åˆ—è¡¨
        async function loadArrivedCountries() {
            try {
                const response = await fetch(`/api/rollcall/arrived?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const arrivedIds = data.data || [];
                    
                    // è·å–å›½å®¶è¯¦ç»†ä¿¡æ¯
                    const countriesResponse = await fetch(`/api/countries?session_id=${encodeURIComponent(sessionId)}`);
                    const countriesData = await countriesResponse.json();
                    
                    if (countriesData.code === 200) {
                        const allCountriesData = countriesData.data || [];
                        
                        // ç­›é€‰å‡ºåˆ°åœºçš„å›½å®¶
                        arrivedCountries = allCountriesData.filter(country => 
                            arrivedIds.includes(country.id)
                        );
                        
                        console.log('åˆ°åœºå›½å®¶æ•°é‡:', arrivedCountries.length);
                        renderCountries();
                        updateStats();
                    }
                } else {
                    showError('åŠ è½½åˆ°åœºå›½å®¶å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½åˆ°åœºå›½å®¶å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ–‡ä»¶æäº¤æƒ…å†µ
        async function loadSubmissions() {
            try {
                const response = await fetch(`/api/submissions?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const submissions = data.data || [];
                    
                    // å¤„ç†æäº¤æ•°æ®
                    submissionData = {};
                    submissions.forEach(submission => {
                        submissionData[submission.country_id] = {
                            status: 'submitted',
                            filename: submission.file_name || 'æ–‡æœ¬æäº¤',
                            submitTime: formatDateTime(submission.created_at),
                            size: submission.file_name ? 'æœªçŸ¥å¤§å°' : 'æ–‡æœ¬å†…å®¹',
                            text: submission.text
                        };
                    });
                    
                    console.log('æ–‡ä»¶æäº¤æ•°é‡:', submissions.length);
                    renderSubmissionStatus();
                    updateStats();
                } else {
                    showError('åŠ è½½æäº¤çŠ¶æ€å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½æäº¤çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“å›½å®¶åˆ—è¡¨
        function renderCountries() {
            if (arrivedCountries.length === 0) {
                countriesList.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸŒ</div><div>æš‚æ— åˆ°åœºå›½å®¶</div></div>';
                return;
            }
            
            const filteredCountries = arrivedCountries.filter(country => 
                country.name.toLowerCase().includes(searchTerm)
            );
            
            countriesList.innerHTML = filteredCountries.map(country => {
                const submission = submissionData[country.id];
                const status = submission ? submission.status : 'pending';
                const statusClass = status === 'submitted' ? 'submitted' : 'pending';
                const statusBadge = getStatusBadge(status);
                
                return `
                    <div class="country-item ${statusClass}">
                        <img class="country-flag" src="${country.flag_url}" alt="${country.name}" onerror="this.src='/static/flags/default.png'">
                        <div class="country-info">
                            <div class="country-name">${country.name}</div>
                            <div class="country-status">
                                ${submission && submission.filename ? 
                                    `æ–‡ä»¶ï¼š${submission.filename} (${submission.size})` : 
                                    'å°šæœªæäº¤æ–‡ä»¶'
                                }
                            </div>
                        </div>
                        <div class="file-info">
                            <span class="status-badge ${status}">${statusBadge}</span>
                            <div class="file-actions">
                                ${submission && submission.filename ? 
                                    `<button class="btn btn-success btn-small" onclick="viewFile('${country.id}')">ğŸ‘ï¸ æŸ¥çœ‹</button>` :
                                    ``
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ¸²æŸ“æäº¤çŠ¶æ€
        function renderSubmissionStatus() {
            const filteredCountries = arrivedCountries.filter(country => {
                if (currentFilter === 'all') return true;
                const submission = submissionData[country.id];
                const status = submission ? submission.status : 'pending';
                return status === currentFilter;
            });
            
            if (filteredCountries.length === 0) {
                submissionStatus.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å›½å®¶</div>
                    </div>
                `;
                return;
            }
            
            submissionStatus.innerHTML = filteredCountries.map(country => {
                const submission = submissionData[country.id];
                const status = submission ? submission.status : 'pending';
                const statusClass = status === 'submitted' ? 'submitted' : 'pending';
                const statusBadge = getStatusBadge(status);
                
                return `
                    <div class="country-item ${statusClass}">
                        <img class="country-flag" src="${country.flag_url}" alt="${country.name}" onerror="this.src='/static/flags/default.png'">
                        <div class="country-info">
                            <div class="country-name">${country.name}</div>
                            <div class="country-status">
                                ${submission && submission.submitTime ? 
                                    `æäº¤æ—¶é—´ï¼š${submission.submitTime}` : 
                                    'ç­‰å¾…æäº¤'
                                }
                            </div>
                        </div>
                        <div class="file-info">
                            <span class="status-badge ${status}">${statusBadge}</span>
                            <div class="file-actions">
                                ${submission && submission.filename ? 
                                    `<button class="btn btn-success btn-small" onclick="viewFile('${country.id}')">ğŸ‘ï¸ æŸ¥çœ‹</button>` :
                                    ``
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // è·å–çŠ¶æ€å¾½ç« 
        function getStatusBadge(status) {
            switch (status) {
                case 'submitted': return 'âœ… å·²æäº¤';
                case 'pending': return 'â³ å¾…æäº¤';
                default: return 'â“ æœªçŸ¥';
            }
        }
        
        // æŒ‰çŠ¶æ€ç­›é€‰
        function filterByStatus(status) {
            currentFilter = status;
            renderSubmissionStatus();
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.panel-actions .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            const filterTexts = { 'all': 'å…¨éƒ¨', 'pending': 'å¾…æäº¤', 'submitted': 'å·²æäº¤' };
            const activeBtn = Array.from(document.querySelectorAll('.panel-actions .btn')).find(btn => 
                btn.textContent.includes(filterTexts[status])
            );
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }
        }
        
        // æŸ¥çœ‹æ–‡ä»¶
        function viewFile(countryId) {
            const country = arrivedCountries.find(c => c.id === countryId);
            const submission = submissionData[countryId];
            
            if (!submission) {
                showError('æ–‡ä»¶ä¸å­˜åœ¨');
                return;
            }
            
            modalTitle.textContent = `${country.name} - ${submission.filename}`;
            
            if (submission.filename === 'æ–‡æœ¬æäº¤') {
                // æ˜¾ç¤ºæ–‡æœ¬å†…å®¹
                filePreview.innerHTML = `
                    <div style="padding: 20px;">
                        <h4>æ–‡æœ¬å†…å®¹ï¼š</h4>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 12px; line-height: 1.6; white-space: pre-wrap;">${submission.text}</div>
                        <p style="color: #6b7280; margin: 16px 0;">æäº¤æ—¶é—´ï¼š${submission.submitTime}</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
                        </div>
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                filePreview.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
                        <h3>${submission.filename}</h3>
                        <p style="color: #6b7280; margin: 10px 0;">æ–‡ä»¶å¤§å°ï¼š${submission.size}</p>
                        <p style="color: #6b7280; margin: 10px 0;">æäº¤æ—¶é—´ï¼š${submission.submitTime}</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="downloadFile('${countryId}')">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</button>
                            <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
                        </div>
                    </div>
                `;
            }
            
            fileModal.style.display = 'block';
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(countryId) {
            const submission = submissionData[countryId];
            if (submission && submission.filename && submission.filename !== 'æ–‡æœ¬æäº¤') {
                const downloadUrl = `/static/uploads/${submission.filename}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = submission.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess(`å¼€å§‹ä¸‹è½½ ${submission.filename}`);
            } else {
                showError('æ— æ³•ä¸‹è½½è¯¥æ–‡ä»¶');
            }
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            fileModal.style.display = 'none';
        }
        

        // å‘é€æé†’
        async function sendReminder() {
            try {
                const pendingCountries = arrivedCountries.filter(country => {
                    const submission = submissionData[country.id];
                    return !submission || submission.status === 'pending';
                });
                
                if (pendingCountries.length === 0) {
                    showError('æ‰€æœ‰å›½å®¶éƒ½å·²æäº¤æ–‡ä»¶');
                    return;
                }
                
                const countryIds = pendingCountries.map(c => c.id);
                
                const response = await fetch('/api/send_submission_reminder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        country_ids: countryIds
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    showSuccess(data.message);
                } else {
                    showError(data.message || 'å‘é€æé†’å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å‘é€æé†’å¤±è´¥:', error);
                showError('å‘é€æé†’æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }
        
        // å‘é€ä¸ªåˆ«æé†’
        async function sendIndividualReminder(countryId) {
            try {
                const country = arrivedCountries.find(c => c.id === countryId);
                
                const response = await fetch('/api/send_submission_reminder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        country_ids: [countryId]
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    showSuccess(`å·²å‘ ${country.name} å‘é€æäº¤æé†’`);
                } else {
                    showError(data.message || 'å‘é€æé†’å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å‘é€ä¸ªåˆ«æé†’å¤±è´¥:', error);
                showError('å‘é€æé†’æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }
        
        // å»¶é•¿æˆªæ­¢æ—¶é—´
        async function extendDeadline() {
            const newDeadline = prompt('è¯·è¾“å…¥æ–°çš„æˆªæ­¢æ—¶é—´ (æ ¼å¼ï¼šYYYY-MM-DD HH:MM)');
            if (newDeadline) {
                try {
                    const response = await fetch('/api/extend_submission_deadline', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            new_deadline: newDeadline
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        document.getElementById('deadline-time').textContent = newDeadline;
                        showSuccess(data.message);
                    } else {
                        showError(data.message || 'æ›´æ–°æˆªæ­¢æ—¶é—´å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('å»¶é•¿æˆªæ­¢æ—¶é—´å¤±è´¥:', error);
                    showError('å»¶é•¿æˆªæ­¢æ—¶é—´æ—¶å‘ç”Ÿé”™è¯¯');
                }
            }
        }
        
        // è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
        function proceedToNext() {
            const submittedCount = Object.values(submissionData).filter(s => s.status === 'submitted').length;
            const totalCount = arrivedCountries.length;
            
            if (submittedCount < totalCount) {
                if (confirm(`è¿˜æœ‰ ${totalCount - submittedCount} ä¸ªå›½å®¶æœªæäº¤æ–‡ä»¶ï¼Œç¡®å®šè¦è¿›å…¥ä¸‹ä¸€é˜¶æ®µå—ï¼Ÿ`)) {
                    proceedToMotion();
                }
            } else {
                proceedToMotion();
            }
        }
        
        // è·³è½¬åˆ°åŠ¨è®®é˜¶æ®µ
        function proceedToMotion() {
            showSuccess('æ­£åœ¨è¿›å…¥åŠ¨è®®ç®¡ç†é˜¶æ®µ...');
            setTimeout(() => {
                const url = `/chairman-motion?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}`;
                window.location.href = url;
            }, 1000);
        }
        
        // è·³è¿‡åŠ¨è®®ç›´æ¥æŠ•ç¥¨
        function skipToVoting() {
            if (confirm('ç¡®å®šè¦è·³è¿‡åŠ¨è®®é˜¶æ®µï¼Œç›´æ¥è¿›å…¥æŠ•ç¥¨å—ï¼Ÿ')) {
                showSuccess('æ­£åœ¨è¿›å…¥æŠ•ç¥¨ç›‘æ§é˜¶æ®µ...');
                setTimeout(() => {
                    const url = `/chairman-vote-monitoring?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}&mechanism_name=${encodeURIComponent(mechanismName)}&mechanism_requirement=${encodeURIComponent(mechanismRequirement)}`;
                    window.location.href = url;
                }, 1000);
            }
        }
        
        // è·³è¿‡åŠ¨è®®ç›´æ¥æŠ•ç¥¨
        function skipToVoting() {
            if (confirm('ç¡®å®šè¦è·³è¿‡åŠ¨è®®é˜¶æ®µï¼Œç›´æ¥è¿›å…¥æŠ•ç¥¨å—ï¼Ÿ')) {
                showSuccess('æ­£åœ¨è¿›å…¥æŠ•ç¥¨ç›‘æ§é˜¶æ®µ...');
                setTimeout(() => {
                    const url = `/chairman-vote-monitoring?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}&mechanism_name=${encodeURIComponent(mechanismName)}&mechanism_requirement=${encodeURIComponent(mechanismRequirement)}`;
                    window.location.href = url;
                }, 1000);
            }
        }
        
        // è¿”å›ç‚¹åé¡µé¢
        function goBack() {
            const url = `/chairman-rollcall?session_id=${encodeURIComponent(sessionId)}&committee_name=${encodeURIComponent(committeeName)}&agenda=${encodeURIComponent(agenda)}&mechanism_name=${encodeURIComponent(mechanismName)}&mechanism_requirement=${encodeURIComponent(mechanismRequirement)}`;
            window.location.href = url;
        }
        
        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            showSuccess('æ­£åœ¨åˆ·æ–°æ•°æ®...');
            await loadArrivedCountries();
            await loadSubmissions();
            showSuccess('æ•°æ®å·²åˆ·æ–°');
        }
        
        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport() {
            const submittedCount = Object.values(submissionData).filter(s => s.status === 'submitted').length;
            const totalCount = arrivedCountries.length;
            const rate = totalCount > 0 ? Math.round((submittedCount / totalCount) * 100) : 0;
            
            const reportData = {
                sessionId,
                committeeName,
                agenda,
                totalCountries: totalCount,
                submittedCount,
                submissionRate: rate,
                timestamp: new Date().toLocaleString()
            };
            
            const reportText = `æ–‡ä»¶æäº¤ç›‘æ§æŠ¥å‘Š
            
ä¼šè®®ç¼–å·ï¼š${sessionId}
å§”å‘˜ä¼šï¼š${committeeName}
è®®é¢˜ï¼š${agenda}
ç”Ÿæˆæ—¶é—´ï¼š${reportData.timestamp}

ç»Ÿè®¡ä¿¡æ¯ï¼š
- åˆ°åœºå›½å®¶æ•°ï¼š${totalCount}
- å·²æäº¤æ–‡ä»¶ï¼š${submittedCount}
- æäº¤ç‡ï¼š${rate}%

è¯¦ç»†æƒ…å†µï¼š
${arrivedCountries.map(country => {
    const submission = submissionData[country.id];
    const status = submission ? 'å·²æäº¤' : 'å¾…æäº¤';
    const time = submission ? submission.submitTime : 'æœªæäº¤';
    return `- ${country.name}ï¼š${status} (${time})`;
}).join('\n')}`;
            
            // ä¸‹è½½æŠ¥å‘Š
            const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ–‡ä»¶æäº¤ç›‘æ§æŠ¥å‘Š_${sessionId}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showSuccess('æŠ¥å‘Šå·²å¯¼å‡º');
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const total = arrivedCountries.length;
            const submitted = Object.values(submissionData).filter(s => s.status === 'submitted').length;
            const pending = total - submitted;
            const rate = total > 0 ? Math.round((submitted / total) * 100) : 0;
            
            totalCountriesEl.textContent = total;
            submittedCountEl.textContent = submitted;
            pendingCountEl.textContent = pending;
            submissionRateEl.textContent = rate + '%';
            
            // æ›´æ–°è¿›å…¥ä¸‹ä¸€é˜¶æ®µæŒ‰é’®çŠ¶æ€
            const proceedBtn = document.getElementById('proceed-btn');
            if (submitted > 0) {
                proceedBtn.disabled = false;
                proceedBtn.textContent = 'âœ… è¿›å…¥ä¸‹ä¸€é˜¶æ®µ';
            } else {
                proceedBtn.disabled = true;
                proceedBtn.textContent = 'âœ… è¿›å…¥ä¸‹ä¸€é˜¶æ®µ (éœ€è¦è‡³å°‘1ä¸ªæäº¤)';
            }
        }
        
        // å€’è®¡æ—¶åŠŸèƒ½
        function startCountdown() {
            const deadline = new Date('2024-12-31 23:59:00').getTime();
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = deadline - now;
                
                if (distance < 0) {
                    timeRemaining.textContent = 'å·²è¿‡æœŸ';
                    deadlineInfo.classList.add('warning');
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                
                timeRemaining.textContent = `å‰©ä½™ ${days}å¤© ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
                
                if (days === 0 && hours < 24) {
                    deadlineInfo.classList.add('warning');
                }
            }
            
            updateCountdown();
            setInterval(updateCountdown, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(isoString) {
            if (!isoString) return 'æœªçŸ¥æ—¶é—´';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            alert.className = 'alert alert-success show';
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            alert.className = 'alert alert-error show';
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target === fileModal) {
                closeModal();
            }
        }
    </script>
</body>
</html>