<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±åŒå®£è¨€æŸ¥çœ‹ - {{ country_name }}ä»£è¡¨å›¢ï½œWTO æ¨¡æ‹Ÿè°ˆåˆ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar-left h1 {
            font-size: 20px;
            color: #2c3e50;
            font-weight: 600;
        }

        .country-identity {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .country-flag-small {
            width: 32px;
            height: 24px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .country-name-small {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 16px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            margin: 0 0 8px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .declaration-info {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .declaration-info h3 {
            margin: 0 0 16px;
            color: #1e293b;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .info-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        .my-contribution {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .my-contribution h4 {
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contribution-text {
            color: #374151;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .participation-status {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .participation-status strong {
            color: #065f46;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .panel-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .panel-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .source-files {
            max-height: 350px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .file-item.my-file {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .file-item.included {
            border-left-color: #10b981;
            background: #ecfdf5;
        }
        
        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .country-flag {
            width: 32px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .file-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .file-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .file-status.included {
            background: #10b981;
            color: white;
        }

        .file-status.my-file {
            background: #f59e0b;
            color: white;
        }

        .declaration-viewer {
            height: 100%;
        }

        .declaration-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            min-height: 500px;
            line-height: 1.8;
            font-size: 16px;
            color: #374151;
            white-space: pre-wrap;
            border-left: 4px solid #3b82f6;
        }

        .declaration-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .feedback-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .feedback-textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .feedback-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .stats-section {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }
        
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert.show {
            display: block;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .declaration-actions {
                flex-direction: column;
            }
            
            .topbar-content {
                flex-direction: column;
                gap: 12px;
            }
        }

    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-content">
            <div class="topbar-left">
                <h1>WTO æ¨¡æ‹Ÿè°ˆåˆ¤ - å…±åŒå®£è¨€</h1>
            </div>
            <div class="country-identity">
                <img class="country-flag-small" src="{{ country_flag_url }}" alt="{{ country_name }}" onerror="this.src='/static/flags/default.png'">
                <span class="country-name-small">{{ country_name }}ä»£è¡¨å›¢</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <h1>ğŸ“œ å…±åŒå®£è¨€</h1>
            <p>æŸ¥çœ‹å’Œç¡®è®¤ä¼šè®®è¾¾æˆçš„å…±åŒå®£è¨€</p>
        </div>

        <!-- å®£è¨€ä¿¡æ¯ -->
        <div class="declaration-info">
            <h3>ğŸ“‹ å®£è¨€ä¿¡æ¯</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">ä¼šè®®ç¼–å·ï¼š</span>
                    <span class="info-value">{{ session_id or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å§”å‘˜ä¼šï¼š</span>
                    <span class="info-value">{{ committee_name or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">è®®é¢˜ï¼š</span>
                    <span class="info-value">{{ agenda or 'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å®£è¨€å‘å¸ƒï¼š</span>
                    <span class="info-value" id="declaration-time">{{ declaration_time or 'æœªè®¾ç½®' }}</span>
                </div>
            </div>
            
            <div class="my-contribution">
                <h4>{{ country_flag_emoji }} {{ country_name }}çš„è´¡çŒ®</h4>
                <div class="contribution-text" id="my-contribution-text">
                    æ­£åœ¨åŠ è½½æ‚¨çš„è´¡çŒ®ä¿¡æ¯...
                </div>
            </div>
            
            <div class="participation-status">
                <strong>å‚ä¸çŠ¶æ€ï¼š</strong>
                <span id="participation-status-text">æ­£åœ¨åŠ è½½å‚ä¸çŠ¶æ€...</span>
            </div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div id="alert" class="alert"></div>


        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- çº³å…¥å®£è¨€çš„æ–‡ä»¶ -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon">ğŸ“„</div>
                    <div class="panel-title">çº³å…¥å®£è¨€çš„æ–‡ä»¶</div>
                </div>
                
                <div class="source-files" id="source-files">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
                        <div>æ­£åœ¨åŠ è½½æ–‡ä»¶ä¿¡æ¯...</div>
                    </div>
                </div>
            </div>
            
            <!-- å®£è¨€å†…å®¹æŸ¥çœ‹ -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon">ğŸ“œ</div>
                    <div class="panel-title">å…±åŒå®£è¨€å†…å®¹</div>
                </div>
                
                <div class="declaration-viewer">
                    <div class="declaration-content" id="declaration-content">
                        æ­£åœ¨åŠ è½½å…±åŒå®£è¨€å†…å®¹...
                    </div>
                    
                    <div class="declaration-actions">
                        <button class="btn btn-primary" onclick="downloadDeclaration()">
                            ğŸ“¥ ä¸‹è½½å®£è¨€
                        </button>
                        <button class="btn btn-success" onclick="confirmDeclaration()" id="confirm-btn">
                            âœ… ç¡®è®¤å®£è¨€
                        </button>
                        <button class="btn btn-warning" onclick="provideFeedback()">
                            ğŸ’¬ æä¾›åé¦ˆ
                        </button>
                        <button class="btn btn-secondary" onclick="shareDeclaration()">
                            ğŸ“¤ åˆ†äº«å®£è¨€
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åé¦ˆæ„è§ -->
        <div class="feedback-section">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="panel-icon">ğŸ’¬</div>
                    <div class="panel-title-text">å¯¹å®£è¨€çš„åé¦ˆæ„è§</div>
                </div>
            </div>
            
            <textarea class="feedback-textarea" id="feedback-content" placeholder="è¯·åœ¨æ­¤å¤„æä¾›æ‚¨å¯¹å…±åŒå®£è¨€çš„åé¦ˆæ„è§å’Œå»ºè®®...

æ‚¨å¯ä»¥å°±ä»¥ä¸‹æ–¹é¢æä¾›æ„è§ï¼š
1. å®£è¨€å†…å®¹çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
2. {{ country_name }}ç«‹åœºçš„ä½“ç°ç¨‹åº¦
3. å…·ä½“æ¡æ¬¾çš„è¡¨è¿°å»ºè®®
4. å®æ–½æ–¹æ¡ˆçš„å¯è¡Œæ€§
5. å…¶ä»–æ”¹è¿›å»ºè®®"></textarea>
            
            <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-success" onclick="submitFeedback()">ğŸ“¤ æäº¤åé¦ˆ</button>
                <button class="btn btn-secondary" onclick="saveFeedbackDraft()">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="signing-countries">0</div>
                    <div class="stat-label">ç­¾ç½²å›½å®¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="declaration-words">0</div>
                    <div class="stat-label">å®£è¨€å­—æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="key-points">0</div>
                    <div class="stat-label">æ ¸å¿ƒè¦ç‚¹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="my-status">æœªç¡®è®¤</div>
                    <div class="stat-label">æ‚¨çš„çŠ¶æ€</div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // å…¨å±€å˜é‡
        let sessionId = "{{ session_id or '' }}";
        let committeeName = "{{ committee_name or '' }}";
        let agenda = "{{ agenda or '' }}";
        let countryId = "{{ country_id or '' }}";
        let countryName = "{{ country_name or '' }}";
        
        let confirmationStatus = false;
        let feedbackSubmitted = false;
        let declarationData = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¸ä¼šå›½å…±åŒå®£è¨€é¡µé¢å·²åŠ è½½');
            console.log('å›½å®¶ä¿¡æ¯:', { countryId, countryName });
            
            loadDeclaration();
            loadIncludedFiles();
            loadMyParticipation();
            initializePage();
        });

        // åŠ è½½å…±åŒå®£è¨€
        async function loadDeclaration() {
            try {
                const response = await fetch(`/api/get_declarations?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.length > 0) {
                    // è·å–æœ€æ–°çš„å®£è¨€
                    declarationData = data.data[0];
                    
                    document.getElementById('declaration-content').textContent = declarationData.declaration;
                    document.getElementById('declaration-time').textContent = formatDateTime(declarationData.created_at || declarationData.generated_at);
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    const wordCount = declarationData.declaration.length;
                    const signingCountries = declarationData.participating_countries || [];
                    
                    document.getElementById('signing-countries').textContent = signingCountries.length;
                    document.getElementById('declaration-words').textContent = wordCount.toLocaleString();
                    document.getElementById('key-points').textContent = '5'; // å¯ä»¥é€šè¿‡åˆ†ææ–‡æœ¬è®¡ç®—
                    
                    console.log('å…±åŒå®£è¨€å·²åŠ è½½');
                } else {
                    document.getElementById('declaration-content').textContent = 'å…±åŒå®£è¨€å°šæœªç”Ÿæˆï¼Œè¯·ç­‰å¾…ä¸»å¸­å®Œæˆå®£è¨€åˆ¶ä½œã€‚';
                    showAlert('å…±åŒå®£è¨€å°šæœªç”Ÿæˆï¼Œè¯·ç­‰å¾…ä¸»å¸­å®Œæˆ', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å…±åŒå®£è¨€å¤±è´¥:', error);
                showAlert('åŠ è½½å…±åŒå®£è¨€æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }

        // åŠ è½½çº³å…¥å®£è¨€çš„æ–‡ä»¶
        async function loadIncludedFiles() {
            try {
                const response = await fetch(`/api/get_passed_submissions?session_id=${encodeURIComponent(sessionId)}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const passedFiles = data.data || [];
                    
                    // è·å–å›½å®¶ä¿¡æ¯
                    const countriesResponse = await fetch(`/api/countries?session_id=${encodeURIComponent(sessionId)}`);
                    const countriesData = await countriesResponse.json();
                    
                    if (countriesData.code === 200) {
                        const allCountries = countriesData.data || [];
                        
                        const sourceFilesEl = document.getElementById('source-files');
                        
                        if (passedFiles.length === 0) {
                            sourceFilesEl.innerHTML = `
                                <div style="text-align: center; padding: 40px; color: #6b7280;">
                                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
                                    <div>æš‚æ— é€šè¿‡æŠ•ç¥¨çš„æ–‡ä»¶</div>
                                </div>
                            `;
                            return;
                        }
                        
                        sourceFilesEl.innerHTML = passedFiles.map(file => {
                            const country = allCountries.find(c => c.id === file.country_id);
                            const isMyFile = file.country_id === countryId;
                            const statusClass = isMyFile ? 'my-file' : 'included';
                            const statusText = isMyFile ? `${countryName} æˆ‘çš„æ–‡ä»¶` : 'âœ… å·²çº³å…¥';
                            
                            return `
                                <div class="file-item ${statusClass}">
                                    <img class="country-flag" src="${country ? country.flag_url : '/static/flags/default.png'}" alt="${country ? country.name : 'æœªçŸ¥'}" onerror="this.src='/static/flags/default.png'">
                                    <div class="file-info">
                                        <div class="file-title">${file.file_name || 'æ–‡æœ¬æäº¤'}</div>
                                        <div class="file-meta">${country ? country.name : 'æœªçŸ¥å›½å®¶'} â€¢ å·²é€šè¿‡æŠ•ç¥¨</div>
                                    </div>
                                    <span class="file-status ${statusClass}">${statusText}</span>
                                </div>
                            `;
                        }).join('');
                        
                        // æ›´æ–°æˆ‘çš„è´¡çŒ®ä¿¡æ¯
                        const myFile = passedFiles.find(f => f.country_id === countryId);
                        if (myFile) {
                            document.getElementById('my-contribution-text').textContent = 
                                `æ‚¨çš„${myFile.file_name || 'æ–‡æœ¬æäº¤'}å·²è¢«çº³å…¥å…±åŒå®£è¨€çš„åˆ¶å®šè¿‡ç¨‹ä¸­ï¼Œæ‚¨çš„è§‚ç‚¹å’Œå»ºè®®å¾—åˆ°äº†ä½“ç°ã€‚`;
                            document.getElementById('participation-status-text').textContent = 
                                'æ‚¨çš„æ–‡ä»¶å·²é€šè¿‡æŠ•ç¥¨å¹¶çº³å…¥å®£è¨€';
                        } else {
                            document.getElementById('my-contribution-text').textContent = 
                                'æ‚¨çš„æ–‡ä»¶æœªé€šè¿‡æŠ•ç¥¨ï¼Œä½†æ‚¨ä»å¯ä»¥æŸ¥çœ‹å’Œç¡®è®¤æœ€ç»ˆçš„å…±åŒå®£è¨€ã€‚';
                            document.getElementById('participation-status-text').textContent = 
                                'æ‚¨çš„æ–‡ä»¶æœªçº³å…¥å®£è¨€ï¼Œä½†å¯å‚ä¸ç¡®è®¤è¿‡ç¨‹';
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½çº³å…¥æ–‡ä»¶å¤±è´¥:', error);
            }
        }

        // åŠ è½½æˆ‘çš„å‚ä¸æƒ…å†µ
        async function loadMyParticipation() {
            try {
                const response = await fetch(`/api/get_declaration_participation?session_id=${encodeURIComponent(sessionId)}&country_id=${encodeURIComponent(countryId)}`);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    confirmationStatus = data.data.confirmed || false;
                    feedbackSubmitted = data.data.feedback_submitted || false;
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    document.getElementById('my-status').textContent = confirmationStatus ? 'å·²ç¡®è®¤' : 'æœªç¡®è®¤';
                    
                    if (confirmationStatus) {
                        const confirmBtn = document.getElementById('confirm-btn');
                        confirmBtn.textContent = 'âœ… å·²ç¡®è®¤';
                        confirmBtn.disabled = true;
                    }
                    
                    if (feedbackSubmitted) {
                        showAlert('æ‚¨å·²æäº¤è¿‡åé¦ˆæ„è§', 'success');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å‚ä¸æƒ…å†µå¤±è´¥:', error);
            }
        }

        // ä¸‹è½½å®£è¨€
        function downloadDeclaration() {
            if (!declarationData) {
                showAlert('å®£è¨€å°šæœªç”Ÿæˆ', 'error');
                return;
            }
            
            const content = declarationData.declaration;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å…±åŒå®£è¨€_${sessionId}_${countryName}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('å®£è¨€å·²ä¸‹è½½', 'success');
        }

        // ç¡®è®¤å®£è¨€
        async function confirmDeclaration() {
            if (confirmationStatus) {
                showAlert('æ‚¨å·²ç¡®è®¤è¿‡æ­¤å®£è¨€', 'success');
                return;
            }
            
            if (confirm(`ç¡®è®¤æ­¤å…±åŒå®£è¨€ä»£è¡¨${countryName}çš„æœ€ç»ˆç«‹åœºå—ï¼Ÿç¡®è®¤åå°†æ— æ³•æ’¤å›ã€‚`)) {
                try {
                    const response = await fetch('/api/confirm_declaration', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            country_id: countryId,
                            country_name: countryName
                        })
                    });

                    const data = await response.json();
                    
                    if (data.code === 200) {
                        confirmationStatus = true;
                        showAlert('æ‚¨å·²ç¡®è®¤å…±åŒå®£è¨€ï¼Œæ„Ÿè°¢å‚ä¸ï¼', 'success');
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        document.getElementById('my-status').textContent = 'å·²ç¡®è®¤';
                        document.getElementById('participation-status-text').textContent = 'æ‚¨å·²ç¡®è®¤å…±åŒå®£è¨€';
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        const confirmBtn = document.getElementById('confirm-btn');
                        confirmBtn.textContent = 'âœ… å·²ç¡®è®¤';
                        confirmBtn.disabled = true;
                    } else {
                        showAlert(data.message || 'ç¡®è®¤å¤±è´¥', 'error');
                    }
                    
                } catch (error) {
                    console.error('ç¡®è®¤å®£è¨€å¤±è´¥:', error);
                    showAlert('ç¡®è®¤æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                }
            }
        }

        // æä¾›åé¦ˆ
        function provideFeedback() {
            const feedbackSection = document.querySelector('.feedback-section');
            feedbackSection.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('feedback-content').focus();
        }

        // æäº¤åé¦ˆ
        async function submitFeedback() {
            const feedback = document.getElementById('feedback-content').value.trim();
            if (!feedback) {
                showAlert('è¯·å…ˆè¾“å…¥åé¦ˆå†…å®¹', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/submit_declaration_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        country_id: countryId,
                        country_name: countryName,
                        feedback: feedback
                    })
                });

                const data = await response.json();
                
                if (data.code === 200) {
                    feedbackSubmitted = true;
                    showAlert('åé¦ˆå·²æäº¤ç»™ä¸»å¸­ï¼Œæ„Ÿè°¢æ‚¨çš„æ„è§ï¼', 'success');
                    saveFeedbackDraft(); // ä¿å­˜æœ¬åœ°å‰¯æœ¬
                } else {
                    showAlert(data.message || 'æäº¤åé¦ˆå¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('æäº¤åé¦ˆå¤±è´¥:', error);
                showAlert('æäº¤åé¦ˆæ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }

        // ä¿å­˜åé¦ˆè‰ç¨¿
        function saveFeedbackDraft() {
            const feedback = document.getElementById('feedback-content').value;
            localStorage.setItem(`declaration-feedback-draft-${countryName}-${sessionId}`, feedback);
            showAlert('åé¦ˆè‰ç¨¿å·²ä¿å­˜', 'success');
        }

        // åˆ†äº«å®£è¨€
        function shareDeclaration() {
            if (!declarationData) {
                showAlert('å®£è¨€å°šæœªç”Ÿæˆ', 'error');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: 'WTOå…±åŒå®£è¨€',
                    text: 'å›½é™…è´¸æ˜“äº‰ç«¯è§£å†³æœºåˆ¶æ”¹é©å…±åŒå®£è¨€',
                    url: window.location.href
                });
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                const content = declarationData.declaration;
                navigator.clipboard.writeText(content).then(() => {
                    showAlert('å®£è¨€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                });
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(isoString) {
            if (!isoString) return 'æœªçŸ¥æ—¶é—´';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN');
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // é¡µé¢åˆå§‹åŒ–
        function initializePage() {
            // åŠ è½½ä¿å­˜çš„åé¦ˆè‰ç¨¿
            const savedFeedback = localStorage.getItem(`declaration-feedback-draft-${countryName}-${sessionId}`);
            if (savedFeedback) {
                document.getElementById('feedback-content').value = savedFeedback;
            }
            
            // è‡ªåŠ¨ä¿å­˜åé¦ˆè‰ç¨¿
            const feedbackTextarea = document.getElementById('feedback-content');
            let autoSaveTimer;
            feedbackTextarea.addEventListener('input', () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveFeedbackDraft();
                }, 5000); // 5ç§’åè‡ªåŠ¨ä¿å­˜
            });
        }

    </script>
</body>
</html>
